<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>PRIME v22 Fixed</title>

    <style>
        /* --- CORE DESIGN --- */
        :root {
            --bg: #000000; --card: #161618; --text: #ffffff; --muted: #8e8e93;
            --accent: #32d74b; /* Green */
            --blue: #0a84ff; --danger: #ff453a; --warn: #ff9f0a; --purple: #bf5af2; --gold: #ffd60a;
            --glass: rgba(22, 22, 24, 0.95); --radius: 18px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-top: env(safe-area-inset-top); padding-bottom: 120px; }

        /* FIXED LAYERING (Z-INDEX) */
        #confetti { position: fixed; top:0; left:0; pointer-events:none; z-index: 0; }
        header { position: sticky; top: 0; z-index: 100; background: var(--glass); backdrop-filter: blur(20px); border-bottom: 1px solid #333; padding: 10px 20px; }
        .container { position: relative; z-index: 10; padding: 0 16px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; position: relative; border: 1px solid #2c2c2e; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10; }
        .bottom-bar { position: fixed; bottom: 0; width: 100%; background: var(--glass); backdrop-filter: blur(20px); border-top: 0.5px solid #333; display: flex; justify-content: space-around; padding: 12px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); z-index: 200; }

        /* HEADER CONTENT */
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { font-size: 1.4rem; font-weight: 900; font-style: italic; letter-spacing: -1px; }
        .xp-container { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--blue)); width: 0%; transition: width 0.5s ease; }
        .level-badge { font-size: 0.7rem; color: var(--blue); font-weight: bold; display: flex; justify-content: space-between; margin-top: 4px; }
        .icon-btn { background: none; border: none; color: var(--text); font-size: 1.2rem; cursor: pointer; opacity: 0.8; user-select:none; }
        .challenge-badge { background: linear-gradient(90deg, #ff9f0a, #ff3b30); color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight:bold; display: flex; align-items: center; gap: 5px; box-shadow: 0 0 10px rgba(255, 159, 10, 0.3); cursor: pointer; }

        /* ALERTS */
        .alert-box { padding: 15px; border-radius: 12px; margin: 15px 16px; font-size: 0.9rem; display: flex; align-items: center; gap: 15px; animation: fadeIn 0.5s; border: 1px solid transparent; position: relative; z-index: 15; }
        .alert-low { background: rgba(10, 132, 255, 0.15); border-color: var(--blue); color: var(--blue); display:none; }
        .alert-high { background: rgba(255, 214, 10, 0.15); border-color: var(--gold); color: var(--gold); display:none; }
        .alert-deload { background: rgba(255, 69, 58, 0.15); border-color: var(--danger); color: var(--danger); display:none; }
        .alert-imbalance { background: rgba(255, 159, 10, 0.15); border-color: var(--warn); color: var(--warn); display:none; }

        /* BOXES */
        .box-header { font-weight: bold; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 8px; display:flex; align-items:center; gap:8px; }
        .prehab-box { background: rgba(10, 132, 255, 0.1); border: 1px solid rgba(10, 132, 255, 0.3); padding: 15px; margin-bottom: 15px; border-radius: 12px; position: relative; z-index: 10; }
        .prehab-item { display:flex; justify-content:space-between; align-items:center; padding: 8px 0; border-bottom:1px solid rgba(10,132,255,0.2); font-size:0.9rem; }
        .prehab-item:last-child { border-bottom:none; }
        .prehab-desc { font-size:0.75rem; color: #aaa; display:block; margin-top:2px; }

        /* TASK ITEMS */
        .task-item { padding: 16px 0; border-bottom: 1px solid #2a2a2a; position: relative; }
        .task-top { display: flex; align-items: center; gap: 12px; }
        .task-visual { width: 50px; height: 50px; background: #252527; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #333; cursor: pointer; user-select:none; }
        .task-visual svg { width: 30px; height: 30px; fill: #fff; }
        .checked .task-visual svg { fill: var(--accent); }
        .check-group { display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; user-select:none; }
        .circle-check { width: 24px; height: 24px; border: 2px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s; }
        .checked .circle-check { background: var(--accent); border-color: var(--accent); }
        .task-name { font-size: 1rem; font-weight: 600; transition: 0.2s; line-height: 1.3; }
        .checked .task-name { color: var(--muted); text-decoration: line-through; }
        .ghost-text { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #555; font-style: italic; pointer-events: none; }
        .guide-text { font-size: 0.8rem; color: var(--blue); margin-top: 5px; display: none; background: rgba(10, 132, 255, 0.1); padding: 8px; border-radius: 6px;}
        .task-item.show-guide .guide-text { display: block; animation: fadeIn 0.3s; }
        .yt-btn { background: #222; color: var(--text); padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 0.7rem; font-weight: bold; border: 1px solid #333; display: flex; align-items: center; gap: 5px; flex-shrink: 0; cursor: pointer; position: relative; z-index: 20; user-select:none; }

        /* INPUTS & RPE */
        .input-row { display: flex; gap: 8px; margin-top: 12px; padding-left: 66px; align-items: center; flex-wrap: wrap; position: relative; z-index: 20; }
        .mini-input { background: #000; border: 1px solid #333; color: #fff; width: 65px; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; font-weight: 600; -webkit-appearance: none; }
        .tool-btn { background: #222; border: 1px solid #333; color: var(--muted); width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select:none; }
        .pr-active { border-color: var(--gold) !important; color: var(--gold) !important; box-shadow: 0 0 10px rgba(255, 214, 10, 0.3); }
        .rpe-container { width: 100%; display: flex; align-items: center; gap: 10px; margin-top: 8px; padding-left: 66px; opacity: 0.6; transition: 0.3s; position: relative; z-index: 20; }
        .rpe-container:hover, .rpe-container.active { opacity: 1; }
        .rpe-slider { -webkit-appearance: none; width: 100%; height: 4px; border-radius: 5px; background: #333; outline: none; }
        .rpe-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 15px; height: 15px; border-radius: 50%; background: var(--blue); cursor: pointer; }

        /* TOGGLES */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--blue); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .sheet { background: #1c1c1e; width: 100%; border-radius: 24px 24px 0 0; padding: 30px 25px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; border-top: 1px solid #333; position: relative; z-index: 301; }
        .full-modal { align-items: center; justify-content: center; }
        .full-modal .sheet { border-radius: 0; width: 100%; height: 100%; max-height: 100%; max-width: 100%; padding-top: env(safe-area-inset-top); }
        .close-sticky { position: fixed; top: 20px; right: 20px; z-index: 999; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #fff; backdrop-filter: blur(10px); border: 1px solid #444; cursor: pointer; }

        /* ANATOMY & STATS */
        .anatomy-container { position: relative; width: 150px; height: 260px; margin: 20px auto; }
        .anatomy-svg { width: 100%; height: 100%; overflow: visible; }
        .muscle-path { fill: #333; stroke: #222; stroke-width: 1; transition: fill 0.5s; }
        .pain-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .pain-part { padding: 8px 16px; background: #222; border: 1px solid #333; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        .pain-part.active { background: var(--danger); color: #fff; border-color: var(--danger); }

        /* BOTTOM & UTILS */
        .tab-btn { font-size: 1.7rem; opacity: 0.5; transition: 0.2s; cursor: pointer; user-select:none; }
        .tab-btn.active { opacity: 1; transform: scale(1.1); color: var(--accent); }
        .timer-float { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateY(150px); background: #1c1c1e; border: 1px solid var(--accent); padding: 12px 24px; border-radius: 40px; display: flex; align-items: center; gap: 15px; z-index: 250; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transition: 0.4s; }
        .timer-float.active { transform: translateX(-50%) translateY(0); }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .track-box { background: #111; padding: 15px; border-radius: 14px; text-align: center; cursor: pointer; border: 1px solid #333; user-select:none; }
        .track-val { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .plate-visual { display: flex; gap: 2px; justify-content: center; align-items: flex-end; height: 60px; margin-top: 15px; }
        .plate { height: 100%; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #000; font-weight: bold; }

        /* NUTRITION EXPANDED */
        .nutri-container { padding-top: 20px; padding-bottom: 80px; }
        .nutri-tabs { display: flex; background: #111; padding: 4px; border-radius: 12px; margin: 15px 0; border: 1px solid #333; }
        .n-tab { flex: 1; text-align: center; padding: 12px; border-radius: 10px; font-size: 0.9rem; color: #777; transition: 0.2s; font-weight: bold; cursor: pointer; user-select:none; }
        .n-tab.active { background: #222; color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .macro-bar-container { margin-bottom: 20px; background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .macro-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; color: #ccc; font-weight: bold; }
        .progress-track { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }
        .food-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .food-item { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .food-item:active { transform: scale(0.98); background: #222; }
        .food-item b { color: #fff; }
        .food-item small { color: #888; }
        .supp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom: 15px; }
        .supp-icon { background: #222; border: 1px solid #333; aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 0.7rem; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .supp-icon.active { opacity: 1; border-color: var(--blue); background: rgba(10, 132, 255, 0.1); box-shadow: 0 0 10px rgba(10, 132, 255, 0.3); }

        /* JUMP & EXTRA BUTTONS */
        .action-btn { width: 100%; margin-top: 10px; padding: 14px; background: #222; border: 1px solid #333; color: var(--text); border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; position: relative; z-index: 10; user-select:none; }
        .action-btn:active { background: #333; }
        .btn-jump { border-color: var(--purple); color: var(--purple); background: rgba(191, 90, 242, 0.1); }
        .spin-btn { width: 100%; padding: 14px; background: #222; border: 1px solid #333; color: #fff; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; user-select:none; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>

    <header>
        <div class="header-top">
            <div style="display:flex; flex-direction:column">
                <div class="app-title">PRIME v22 <span style="font-size:0.8rem; color:var(--purple)">Unleashed</span></div>
                <div style="font-size:0.6rem; letter-spacing:2px; color:var(--blue); font-weight:bold" id="seasonBadge">SEZON Ä°Ã‡Ä°</div>
            </div>
            <div style="display:flex; gap:15px; align-items: center;">
                <div class="challenge-badge" onclick="openModal('challengeModal')">ğŸ† <span id="challengeShort">0/1000</span></div>
                <button class="icon-btn" onclick="openModal('zoneModal')">ğŸ§˜</button>
                <button class="icon-btn" onclick="openModal('settingsModal')">âš™ï¸</button>
            </div>
        </div>
        <div class="xp-container"><div class="xp-fill" id="xpBar"></div></div>
        <div class="level-badge">
            <span id="currentLvl">Lvl 1</span>
            <span id="userRank">Rookie</span>
            <span id="xpText">0 XP</span>
        </div>
    </header>

    <div class="quote-box" id="dailyQuote" style="text-align:center; padding:15px; font-style:italic; color:#888; font-size:0.9rem;">...</div>

    <div class="date-strip" style="display:flex; justify-content:space-between; align-items:center; padding:0 16px; margin-bottom:15px; position:relative; z-index:10;">
        <div class="nav-arrow" onclick="changeDate(-1)" style="font-size:1.5rem; padding:10px; cursor:pointer;">â®</div>
        <div style="font-weight:700; font-size:1.1rem;" id="dateDisplay">BugÃ¼n</div>
        <div class="nav-arrow" onclick="changeDate(1)" style="font-size:1.5rem; padding:10px; cursor:pointer;">â¯</div>
    </div>

    <div class="container">
        <div class="alert-box alert-deload" id="deloadAlert"><span>âš ï¸</span> <div><b>Yorgunluk Tespit Edildi!</b><br>Son 7 gÃ¼n hacmin Ã§ok yÃ¼ksek. YÃ¼kÃ¼ biraz azalt.</div></div>
        <div class="alert-box alert-low" id="lowEnergyAlert"><span>ğŸ¢</span> <div><b>HAFÄ°F ANTRENMAN</b><br>Enerjin dÃ¼ÅŸÃ¼k. BugÃ¼n kendini zorlama.</div></div>
        <div class="alert-box alert-high" id="highEnergyAlert"><span>ğŸš€</span> <div><b>REKOR GÃœNÃœ!</b><br>Enerjin tavan! BugÃ¼n PR denemek iÃ§in harika.</div></div>

        <div class="prehab-box" id="prehabSection">
            <div class="box-header" style="color:var(--blue)">ğŸ›¡ï¸ SakatlÄ±k Ã–nleme & IsÄ±nma</div>
            <div id="prehabList"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <div>
                    <h2 style="margin:0; font-size:1.3rem" id="progTitle">...</h2>
                    <small style="color:var(--muted)" id="progSub">...</small>
                    <div id="readinessBadge" style="font-size:0.65rem; background:#222; display:inline-block; padding:2px 6px; border-radius:4px; margin-top:4px; color:#aaa">Enerji: ?</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:1.5rem; font-weight:900; color:var(--accent)" id="progPercent">%0</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:4px">YÃœK: <span id="totalVolume" style="color:#fff; font-weight:bold">0 kg</span></div>
                </div>
            </div>
            
            <div id="workoutList"></div>
            
            <button class="action-btn btn-jump" onclick="addJumpToToday()">ğŸš€ + AnlÄ±k ZÄ±plama Ekle</button>
            
            <div class="finisher-box" style="margin-top:20px; position:relative; z-index:10;">
                <button class="spin-btn" onclick="spinFinisher()">ğŸ² Cila (Finisher) Ã‡evir</button>
                <div class="finisher-result" id="finisherResult" style="margin-top:10px; font-weight:bold; color:var(--purple); display:none; text-align:center;">...</div>
                <div style="margin-top:10px; font-size:0.7rem; color:#666; text-align:center;">
                    <label><input type="radio" name="fType" value="gym" checked> Salon</label>
                    <label style="margin-left:10px"><input type="radio" name="fType" value="basket"> Saha</label>
                </div>
            </div>
            <button class="action-btn" onclick="openModal('builderModal')" style="margin-top:15px; color:var(--blue)">ğŸ› ï¸ ProgramÄ± DeÄŸiÅŸtir</button>
        </div>

        <div class="card tracker-section">
            <h3 style="margin:0 0 15px 0">ğŸ”‹ GÃ¼nlÃ¼k Takip</h3>
            <div class="grid-3">
                <div class="track-box" onclick="addWater()">
                    <div class="track-val" id="waterCount">0 lt</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">SU</div>
                </div>
                <div class="track-box" onclick="openModal('nutriModal')">
                    <div class="track-val" id="calStatus">0</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">KALORÄ°</div>
                </div>
                <div class="track-box" id="proBox" style="border-color:#333" onclick="openModal('nutriModal')">
                    <div class="track-val" id="proStatus">0g</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">PROTEÄ°N</div>
                </div>
            </div>
            <div id="dailyQuestBox" style="margin-top:10px; background:#111; padding:10px; border-radius:10px; border:1px solid #333;">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:6px;">ğŸ¯ GÃ¼nlÃ¼k GÃ¶revler</div>
            </div>
            <textarea id="journal" style="width:100%; background:#111; color:#fff; border:1px solid #333; border-radius:12px; padding:15px; min-height:80px;" placeholder="Notlar..." oninput="saveData()"></textarea>
        </div>
    </div>

    <div class="timer-float" id="timerFloat">
        <div style="font-size:0.7rem; color:var(--accent); font-weight:bold">REST</div>
        <div class="timer-val" id="timerDisplay">01:30</div>
        <button class="icon-btn" onclick="addTimer(10)" style="color:#fff; font-size:1.1rem">+10</button>
        <button class="icon-btn" onclick="stopTimer()" style="color:var(--danger); font-size:1.1rem">âœ•</button>
    </div>
    
    <div class="bottom-bar">
        <div class="tab-btn" onclick="togglePanic()">ğŸ </div>
        <div class="tab-btn" onclick="openModal('nutriModal')">ğŸ</div>
        <div class="tab-btn active" onclick="window.scrollTo(0,0)">ğŸ’ª</div>
        <div class="tab-btn" onclick="openModal('statsModal')">ğŸ“Š</div>
    </div>

    <div class="modal full-modal" id="clutchModal"><div class="sheet clutch-modal" style="text-align:center;"><div style="font-size:3rem; margin-bottom:10px">ğŸ”¥</div><h2 class="clutch-title">CLUTCH TIME!</h2><p style="color:#ccc; margin-top:10px">MaÃ§Ä±n son topu elinde.</p><div class="clutch-task" id="clutchTaskDisplay">...</div><div style="color:var(--gold); font-size:0.9rem; margin-bottom:20px">Ã–dÃ¼l: 2x XP</div><button onclick="completeClutch()" class="spin-btn" style="width:100%; justify-content:center; background:var(--danger); margin-bottom:10px">YAPTIM (+XP)</button><button onclick="closeModal('clutchModal'); showWrapUp()" style="background:none; border:none; color:#777; text-decoration:underline">Pas GeÃ§</button></div></div>
    <div class="modal full-modal" id="zoneModal"><div class="sheet" style="text-align:center"><div style="display:flex; justify-content:space-between;"><h2>Zone Modu</h2><span onclick="closeZone()">âœ•</span></div><p style="color:#777; font-size:0.9rem">Kutu Nefes: 4 Al - 4 Tut - 4 Ver - 4 Tut</p><div class="breathing-circle" id="breathCircle" style="width:150px; height:150px; border:4px solid #333; border-radius:50%; margin:30px auto; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-weight:bold; color:var(--blue); transition:all 4s ease-in-out;">BAÅLA</div><div class="breathing-text" id="breathText">Odaklan...</div><button onclick="startBreathing()" class="spin-btn" style="margin-top:30px; width:100%; justify-content:center">BaÅŸlat</button></div></div>
    <div class="modal full-modal" id="wrapUpModal"><div class="sheet" style="text-align:center; border-color:var(--gold)"><div style="font-size:3rem; margin-bottom:10px">ğŸ‰</div><h2 style="color:var(--gold); font-size:1.8rem; margin:0">ANTRENMAN TAMAMLANDI!</h2><div class="wrap-stats" style="display:flex; justify-content:space-around; margin:20px 0;"><div class="wrap-box"><div class="wrap-val" id="wrapVol">0</div><div style="font-size:0.8rem; color:#777">Toplam YÃ¼k (Kg)</div></div><div class="wrap-box"><div class="wrap-val" id="wrapXP">0</div><div style="font-size:0.8rem; color:#777">KazanÄ±lan XP</div></div></div><div id="wrapExtras" style="font-size:0.8rem; color:#aaa; margin-bottom:15px;"></div><button onclick="closeModal('wrapUpModal')" class="spin-btn" style="width:100%; justify-content:center; background:#333; border:1px solid #555">Kapat</button></div></div>
    
    <div class="modal full-modal" id="nutriModal">
        <div class="sheet nutri-container">
            <div class="close-sticky" onclick="closeModal('nutriModal')">âœ•</div>
            <h2 style="padding:0 20px">Beslenme Merkezi</h2>
            <div style="padding:0 20px">
                <div class="nutri-tabs">
                    <div class="n-tab active" onclick="switchToolTab('track', this)">Takip</div>
                    <div class="n-tab" onclick="switchToolTab('wizard', this)">Sihirbaz</div>
                    <div class="n-tab" onclick="switchToolTab('1rm', this)">1RM & Hesap</div>
                </div>

                <div id="tool-track" class="tool-content active">
                    <div style="text-align:center;margin-bottom:15px">HEDEF: <span id="targetCalDisplay" style="color:var(--gold);font-weight:bold">--</span> kcal / <span id="targetProDisplay" style="color:var(--accent);font-weight:bold">160g</span> Prot</div>
                    <div class="macro-bar-container">
                        <div class="macro-label"><span>Kalori</span><span id="calText">0</span></div>
                        <div class="progress-track"><div class="progress-fill" id="calBar" style="width:0%;background:var(--gold)"></div></div>
                    </div>
                    <div class="macro-bar-container">
                        <div class="macro-label"><span>Protein</span><span id="proText">0</span></div>
                        <div class="progress-track"><div class="progress-fill" id="proBar" style="width:0%;background:var(--accent)"></div></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px; background:#1a1a1a; padding:10px; border-radius:12px; border:1px solid #333;">
                        <input type="number" id="quickCal" class="mini-input" style="flex:1; width:auto;" placeholder="Kcal">
                        <input type="number" id="quickPro" class="mini-input" style="flex:1; width:auto;" placeholder="Prot (g)">
                        <button class="tool-btn" style="width:50px" onclick="addQuickMacros()">+</button>
                    </div>
                    <h4 style="margin-bottom:10px; color:#888;">Supplementler</h4>
                    <div class="supp-grid">
                        <div class="supp-icon" id="supp-creatine" onclick="toggleSupp('creatine')">ğŸ§ª<br>Kreatin</div><div class="supp-icon" id="supp-omega" onclick="toggleSupp('omega')">ğŸŸ<br>Omega3</div>
                        <div class="supp-icon" id="supp-multi" onclick="toggleSupp('multi')">ğŸ’Š<br>Vitamin</div><div class="supp-icon" id="supp-caffeine" onclick="toggleSupp('caffeine')">â˜•<br>Kafein</div>
                    </div>
                    <div class="timing-box" id="nutrientTimingBox" style="display:none; background:rgba(255,214,10,0.1); padding:10px; border-radius:10px; margin-bottom:15px;">
                        <div style="font-weight:bold; color:var(--gold); margin-bottom:5px">âš¡ MAÃ‡ GÃœNÃœ ZAMANLAMASI</div>
                        <div class="timing-item" onclick="toggleTiming('t1')" id="time-t1" style="padding:5px; cursor:pointer;">ğŸ”² MaÃ§tan 3-4 Saat Ã–nce: Karbonhidrat</div>
                        <div class="timing-item" onclick="toggleTiming('t2')" id="time-t2" style="padding:5px; cursor:pointer;">ğŸ”² MaÃ§tan 1 Saat Ã–nce: Hafif AtÄ±ÅŸtÄ±rmalÄ±k</div>
                        <div class="timing-item" onclick="toggleTiming('t3')" id="time-t3" style="padding:5px; cursor:pointer;">ğŸ”² MaÃ§ SonrasÄ± (30dk): Protein & Åeker</div>
                    </div>
                    <h4 style="margin-bottom:10px; color:#888;">HÄ±zlÄ± MenÃ¼</h4>
                    <div class="food-grid" id="foodGrid"></div>
                    <div id="foodLog" class="food-log-list" style="margin-top:15px; font-size:0.8rem; color:#777;"></div>
                    <button onclick="clearNutrition()" style="width:100%; margin-top:20px; padding:10px; background:none; border:1px solid #333; color:#666; border-radius:8px;">Listeyi Temizle</button>
                </div>

                <div id="tool-wizard" class="tool-content" style="display:none;">
                    <button class="spin-btn" style="width:100%; justify-content:center; margin-bottom:15px" onclick="generateMenu()">ğŸ² Rastgele GÃ¼nlÃ¼k MenÃ¼ OluÅŸtur</button>
                    <div id="menuResult"></div>
                </div>
                
                <div id="tool-1rm" class="tool-content" style="display:none;">
                    <div style="display:flex;gap:10px"><input type="number" id="rmWeight" class="mini-input" style="width:50%" placeholder="Kilo"><input type="number" id="rmReps" class="mini-input" style="width:50%" placeholder="Tekrar"></div>
                    <button onclick="calc1RM()" class="spin-btn" style="width:100%;margin-top:15px">1RM Hesapla</button>
                    <div id="rmResult" style="font-size:2rem;text-align:center;margin-top:20px;color:var(--blue)"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal full-modal" id="statsModal">
        <div class="sheet" style="padding-top:60px;">
            <div class="close-sticky" onclick="closeModal('statsModal')">âœ•</div>
            <h2>Ä°statistikler</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="number" id="userHeight" class="mini-input" style="width:50%; padding:15px" placeholder="Boy (cm)" onchange="saveStats()">
                <input type="number" id="dailyWeight" class="mini-input" style="width:50%; padding:15px" placeholder="Kilo (kg)" onchange="saveData()">
            </div>
            <div class="alert-box alert-imbalance" id="legAlert"><span>ğŸ”</span> <div><b>Chicken Leg UyarÄ±sÄ±!</b><br>Ãœst vÃ¼cudun geliÅŸti ama bacaklarÄ± ihmal ediyorsun.</div></div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px; text-align:center">Kas YoÄŸunluk HaritasÄ±</h4>
            <div class="anatomy-container">
                <svg class="anatomy-svg" viewBox="0 0 100 200">
                    <circle cx="50" cy="20" r="10" fill="#333" />
                    <path id="svg-shoulders" class="muscle-path" d="M30 35 L70 35 L75 45 L25 45 Z" />
                    <path id="svg-arms" class="muscle-path" d="M25 45 L15 80 L22 80 L30 45 Z M75 45 L85 80 L78 80 L70 45 Z" />
                    <path id="svg-chest" class="muscle-path" d="M35 45 L65 45 L60 65 L40 65 Z" />
                    <path id="svg-core" class="muscle-path" d="M40 65 L60 65 L58 90 L42 90 Z" />
                    <path id="svg-legs" class="muscle-path" d="M38 90 L62 90 L65 140 L55 140 L52 100 L48 100 L45 140 L35 140 Z" />
                </svg>
            </div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">AÄŸrÄ± HaritasÄ±</h4>
            <div class="pain-grid" id="painMapGrid">
                <div class="pain-part" onclick="togglePain('diz')">Diz</div>
                <div class="pain-part" onclick="togglePain('bel')">Bel</div>
                <div class="pain-part" onclick="togglePain('omuz')">Omuz</div>
                <div class="pain-part" onclick="togglePain('bilek')">Bilek</div>
                <div class="pain-part" onclick="togglePain('kalca')">KalÃ§a</div>
            </div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">Son MaÃ§lar</h4>
            <div id="gameHistory"></div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">BaÅŸarÄ±mlar</h4>
            <div id="achievementsBox"></div>
        </div>
    </div>

    <div class="modal" id="plateModal"><div class="sheet"><h2>Plaka HesaplayÄ±cÄ±</h2><input type="number" id="plateTarget" class="mini-input" style="width:100%; font-size:1.5rem; padding:15px; margin-bottom:10px;" placeholder="Hedef (kg)" oninput="calcPlates()"><div id="plateResult" style="color:var(--accent);font-weight:bold;margin-bottom:10px"></div><div id="plateVisual" class="plate-visual"></div><span onclick="closeModal('plateModal')" style="position:absolute;top:20px;right:20px;font-size:1.5rem; cursor:pointer;">âœ•</span></div></div>
    <div class="modal" id="historyModal"><div class="sheet"><h2 id="histTitle">GeÃ§miÅŸ</h2><div id="histList" style="margin-top:15px;"></div><span onclick="closeModal('historyModal')" style="position:absolute;top:20px;right:20px;font-size:1.5rem; cursor:pointer;">âœ•</span></div></div>
    <div class="modal" id="builderModal"><div class="sheet"><div style="display:flex; justify-content:space-between;"><h2>Program Yap</h2><span onclick="closeModal('builderModal')">âœ•</span></div><select id="mainMuscle" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px" onchange="updateSec()"><option value="">1. BÃ¶lge</option><option value="chest">GÃ¶ÄŸÃ¼s</option><option value="back">SÄ±rt</option><option value="legs">Bacak</option><option value="shoulders">Omuz</option><option value="arms">Kol</option></select><select id="subMuscle" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px" disabled><option>2. BÃ¶lge</option></select><div class="toggle-row"><span>ğŸ€ SÄ±Ã§rama Ekle (Booster)</span><label class="switch"><input type="checkbox" id="addJump"><span class="slider"></span></label></div><button onclick="buildProg()" style="width:100%;padding:15px;background:var(--blue);border:none;border-radius:8px;color:#fff;font-weight:bold">Uygula</button></div></div>
    <div class="modal" id="readinessModal"><div class="sheet"><div style="display:flex; justify-content:space-between;"><h2>GÃ¼nlÃ¼k HazÄ±rlÄ±k</h2><span onclick="closeModal('readinessModal')">âœ•</span></div><p style="color:#aaa; margin-bottom:20px">BugÃ¼n kendini nasÄ±l hissediyorsun?</p><div class="readiness-scale" style="display:flex; justify-content:space-between; font-size:2rem;"><div class="r-btn" onclick="setReadiness(1)">ğŸ˜«</div><div class="r-btn" onclick="setReadiness(2)">ğŸ¥±</div><div class="r-btn" onclick="setReadiness(3)">ğŸ˜</div><div class="r-btn" onclick="setReadiness(4)">ğŸ™‚</div><div class="r-btn" onclick="setReadiness(5)">ğŸ”¥</div></div></div></div>
    <div class="modal" id="gameLogModal"><div class="sheet"><div style="display:flex; justify-content:space-between;"><h2>ğŸ€ MaÃ§ Karnesi</h2><span onclick="closeModal('gameLogModal')">âœ•</span></div><div style="display:flex; gap:10px; margin:20px 0;"><input type="number" id="gamePoints" class="mini-input" style="width:50%; padding:15px" placeholder="SayÄ±"><input type="number" id="gameAssists" class="mini-input" style="width:50%; padding:15px" placeholder="Asist"></div><textarea id="gameNotes" style="width:100%; background:#000; border:1px solid #333; color:#fff; padding:10px; border-radius:8px" placeholder="MaÃ§ yorumu..."></textarea><button onclick="saveGameLog()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:10px; margin-top:15px; font-weight:bold">Kaydet</button></div></div>
    <div class="modal" id="settingsModal"><div class="sheet"><h2>Ayarlar</h2><div class="toggle-row"><span>ğŸ€ Sezon Ä°Ã§i</span><label class="switch"><input type="checkbox" id="seasonToggle" onchange="toggleSeason()"><span class="slider"></span></label></div><div class="toggle-row"><span>ğŸ”Š Ses Efektleri</span><label class="switch"><input type="checkbox" id="soundToggle" onchange="toggleSound()"><span class="slider"></span></label></div><div style="display:flex; gap:10px; margin:20px 0"><button onclick="exportData()" class="backup-btn" style="width:100%; padding:10px; background:#222; color:var(--blue); border:1px solid var(--blue); border-radius:8px;">ğŸ“¥ Ä°ndir</button><button onclick="document.getElementById('importFile').click()" class="backup-btn" style="width:100%; padding:10px; background:#222; color:var(--warn); border:1px solid var(--warn); border-radius:8px;">ğŸ“¤ YÃ¼kle</button><input type="file" id="importFile" style="display:none" onchange="importData(this)"></div><button onclick="resetApp()" style="width:100%; padding:15px; background:var(--danger); border:none; border-radius:10px; color:#fff; font-weight:bold">SÄ±fÄ±rla</button></div></div>
    <div class="modal" id="challengeModal"><div class="sheet"><div style="display:flex; justify-content:space-between;"><h2>Meydan Okuma</h2><span onclick="closeModal('challengeModal')">âœ•</span></div><div style="background:#111; padding:20px; border-radius:12px; text-align:center; margin-top:20px"><h3 style="margin:0; color:var(--warn)" id="challengeTitle">1000 ÅÄ±nav</h3><div style="font-size:2rem; font-weight:bold; margin:10px 0" id="challengeDisplay">0 / 1000</div><div class="progress-track"><div class="progress-fill" id="challengeBarFill" style="width:0%; background:var(--warn)"></div></div><div style="margin-top:20px; display:flex; gap:10px; justify-content:center"><button class="mini-input" onclick="addChallenge(10)">+10</button><button class="mini-input" onclick="addChallenge(25)">+25</button><button class="mini-input" onclick="addChallenge(50)">+50</button></div><button onclick="setChallenge()" style="margin-top:15px; background:none; border:none; color:#555; font-size:0.8rem; text-decoration:underline">Hedefi DeÄŸiÅŸtir</button></div></div></div>

    <!-- Panic / Home Mode Modal -->
    <div class="modal" id="panicModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between;">
                <h2>Ev Modu</h2>
                <span onclick="closeModal('panicModal')">âœ•</span>
            </div>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">BugÃ¼n hangi modu istiyorsun?</p>
            <button class="action-btn" onclick="setPanicMode('micro')">âš¡ 5 Dakika Mikro</button>
            <button class="action-btn" onclick="setPanicMode('classic')">ğŸ’ª Klasik Ev AntrenmanÄ±</button>
            <button class="action-btn" onclick="setPanicMode('recovery')">ğŸ§˜ Recovery & Esneme</button>
            <button class="action-btn" style="margin-top:20px; background:#111; border-color:#333" onclick="disablePanic()">Normal Programa DÃ¶n</button>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal full-modal" id="onboardingModal">
        <div class="sheet">
            <h2>HoÅŸ geldin</h2>
            <p style="color:#aaa; font-size:0.9rem;">Hedefine gÃ¶re PRIME'Ä± kiÅŸiselleÅŸtirelim.</p>
            <label style="font-size:0.8rem; color:#ccc;">Hedefin</label>
            <select id="obGoal" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px">
                <option value="maintain">Formu koru / kondisyon</option>
                <option value="cut">Kilo ver</option>
                <option value="strength">GÃ¼Ã§ kazan</option>
                <option value="jump">SÄ±Ã§rama artÄ±r</option>
            </select>
            <label style="font-size:0.8rem; color:#ccc;">Ekipman</label>
            <select id="obEquip" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px">
                <option value="bodyweight">Sadece vÃ¼cut aÄŸÄ±rlÄ±ÄŸÄ±</option>
                <option value="dumbbells">Dumbbell / kÃ¼Ã§Ã¼k set</option>
                <option value="fullgym">Tam donanÄ±mlÄ± salon</option>
            </select>
            <label style="font-size:0.8rem; color:#ccc;">Aktivite dÃ¼zeyi</label>
            <select id="obActivity" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px">
                <option value="medium">Orta</option>
                <option value="low">DÃ¼ÅŸÃ¼k</option>
                <option value="high">YÃ¼ksek</option>
            </select>
            <button onclick="saveProfile()" class="spin-btn" style="width:100%; justify-content:center; margin-top:20px;">Kaydet</button>
        </div>
    </div>
    
    <script>
        const visuals = {
            push: `<svg viewBox="0 0 24 24"><path d="M4 18h16v-2H4v2zM8 6h8v2H8V6zm4 4c-1.1 0-2 .9-2 2v4h4v-4c0-1.1-.9-2-2-2z" fill="#fff"/></svg>`,
            pull: `<svg viewBox="0 0 24 24"><path d="M12 2C9.24 2 7 4.24 7 7v4h2V7h10v4h2V7c0-2.76-2.24-5-5-5h-4zm-2 12v8h4v-8h-4z" fill="#fff"/></svg>`,
            legs: `<svg viewBox="0 0 24 24"><path d="M12 4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-2 16v-4h4v4h-4zm0-6h4v-2h-4v2zm-4 6h2v-6H6v6zm12 0h2v-6h-2v6z" fill="#fff"/></svg>`,
            press: `<svg viewBox="0 0 24 24"><path d="M12 2L4 10h5v12h6V10h5L12 2z" fill="#fff"/></svg>`,
            core: `<svg viewBox="0 0 24 24"><path d="M20 18h-2v-2h-2v2H8v-2H6v2H4v-6c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v6z" fill="#fff"/></svg>`,
            arm: `<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-2v5H6v2h2v5h2v-5h2v-2z" fill="#fff"/></svg>`,
            cardio: `<svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8.4L13 19v4h2v-5l-1.8-3.6 1.8-1.4c.6-.5 1.1-.7 1.7-.7.3 0 .5.1.8.2L20 13v-2l-2.1-.6c-1.1-.4-2.4-.1-3.2.7l-1.5 1.5-1.4-4.1z" fill="#fff"/></svg>`,
            pilates: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="none" stroke="#fff" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#fff"/></svg>`
        };
        const quotes = ["Yetenek seni zirveye taÅŸÄ±r, karakter orada tutar.", "Antrenman bittiÄŸinde asÄ±l geliÅŸim baÅŸlar.", "BugÃ¼n yaptÄ±ÄŸÄ±n her tekrar yarÄ±nki zaferin tuÄŸlasÄ±dÄ±r.", "Yorgunluk sadece zihnindedir."];

        const muscleDB = {
            chest:{t:"GÃ¶ÄŸÃ¼s", mb:"chest", i:[{n:"Bench Press (4x8)",v:"push",d:"BarÄ± gÃ¶ÄŸÃ¼s ucuna indir."},{n:"Inc. Press (3x10)",v:"push",d:"Ãœst gÃ¶ÄŸsÃ¼ hedefle."}]},
            back:{t:"SÄ±rt", mb:"back", i:[{n:"Pull Up",v:"pull",d:"Ã‡eneni barÄ±n Ã¼zerine Ã§Ä±kar."},{n:"Row",v:"pull",d:"KÃ¼rek kemiklerini sÄ±kÄ±ÅŸtÄ±r."}]},
            legs:{t:"Bacak", mb:"legs", i:[{n:"Squat",v:"legs",d:"Topuklara bas."},{n:"RDL",v:"legs",d:"KalÃ§ayÄ± geriye it."}]},
            shoulders:{t:"Omuz", mb:"shoulders", i:[{n:"OH Press",v:"press",d:"KarnÄ±nÄ± sÄ±k, barÄ± dik it."}]},
            arms:{t:"Kol", mb:"arms", i:[{n:"Curl",v:"arm",d:"Sallanmadan kaldÄ±r."},{n:"Pushdown",v:"arm",d:"Dirsekleri kilitle."}]},
            core:{t:"KarÄ±n", mb:"core", i:[{n:"Plank",v:"core",d:"KalÃ§ayÄ± dÃ¼ÅŸÃ¼rme."}]}
        };

        const compat = { chest:['arms','shoulders'], back:['arms','shoulders'], legs:['core'], shoulders:['arms'], arms:['core'] };
        const jumpR = [
            {n:"Pogo Hops (3x20)", v:"legs", d:"Bilekleri kilitle, hÄ±zlÄ± ve hafif sÄ±Ã§ra."},
            {n:"Box Jump (3x8)", v:"legs", d:"AlÃ§ak bir kutuya patlayÄ±cÄ± ÅŸekilde zÄ±pla."},
            {n:"Depth Jump (3x5)", v:"legs", d:"YÃ¼ksekten in, yere deÄŸer deÄŸmez zÄ±pla (Sistem ÅŸoku)."}
        ];
        const finishers = { gym: ["ğŸ”¥ 1 Dakika Plank", "ğŸ”¥ 50 Mekik", "ğŸ”¥ Tabata Burpee"], basket: ["ğŸ€ 5 Noktadan 10'ar Åut", "ğŸ€ 50 Serbest AtÄ±ÅŸ"] };
        const clutchTasks = ["1 Dakika Plank yapmadan eve gidemezsin!", "Ãœst Ã¼ste 10 serbest atÄ±ÅŸ sok!", "50 ÅÄ±nav Ã§ek, hemen!"];
        const foodDB = [
            {n:"Yumurta (1 Adet)", c:70, p:6}, {n:"Tavuk GÃ¶ÄŸsÃ¼ (150g)", c:165, p:31}, {n:"Pilav (1 Kase)", c:200, p:4},
            {n:"Yulaf (50g)", c:190, p:6}, {n:"Muz (Orta)", c:105, p:1}, {n:"Protein Shake", c:120, p:24},
            {n:"Ton BalÄ±ÄŸÄ± (100g)", c:130, p:25}, {n:"Makarna (1 Tabak)", c:250, p:8}, {n:"FÄ±stÄ±k Ezmesi (1 tk)", c:90, p:3},
            {n:"YoÄŸurt (1 Kase)", c:100, p:10}, {n:"Elma", c:52, p:0}, {n:"Badem (1 AvuÃ§)", c:160, p:6},
            {n:"Lor Peyniri (100g)", c:90, p:15}, {n:"KÃ¶fte (100g)", c:250, p:18}, {n:"Mercimek (1 Tabak)", c:230, p:18},
            {n:"PirinÃ§ PatlaÄŸÄ± (1 ad)", c:30, p:1}
        ];
        const warmupDB = {
            "YÃ¼rÃ¼yÃ¼ÅŸ": {d:"Hafif tempo, kan dolaÅŸÄ±mÄ±nÄ± artÄ±r."},
            "Rotator Cuff": {d:"Omuz baÅŸlarÄ±nÄ± Ä±sÄ±t, sakatlÄ±ÄŸÄ± Ã¶nle."},
            "Tibialis": {d:"Kaval kemiÄŸi kasÄ±nÄ± Ã§alÄ±ÅŸtÄ±r, dizleri koru."},
            "Patellar Tendon": {d:"Diz kapaÄŸÄ± altÄ± izometrik bekleme."},
            "KalÃ§a Flexor": {d:"Lunge pozisyonunda esnet."},
            "Omuz Mob.": {d:"Lastikle omuz aÃ§ma germe."},
            "KalÃ§a Akt.": {d:"Bantla yana yÃ¼rÃ¼yÃ¼ÅŸ veya glute bridge."},
            "Dinamik IsÄ±nma": {d:"Kol Ã§evirme, bacak savurma."},
            "Jacks": {d:"Jumping Jacks, nabzÄ± yÃ¼kselt."}
        };

        const seasonSchedule = {
            0: {t:"Dinlenme", s:"Recovery", j:false, pre:["YÃ¼rÃ¼yÃ¼ÅŸ"], i:[{n:"Meal Prep",v:"rest",d:"Planla."}]},
            1: {t:"Chest & Triceps", s:"Ä°tme", j:false, pre:["Rotator Cuff"], i:[...muscleDB.chest.i, {n:"Pushdown",v:"arm",d:"Ä°zole et."}]},
            2: {t:"Pilates & Basket", s:"YoÄŸun", j:false, pre:["Tibialis"], i:[{n:"Pilates (19:00)",v:"pilates",d:"Core."},{n:"Basketbol (20:45)",v:"cardio",d:"Åut."}]},
            3: {t:"MaÃ§ GÃ¼nÃ¼", s:"Game Night", j:true, pre:["Patellar Tendon"], i:[{n:"MaÃ§ (21:45)",v:"cardio", isGame:true, d:"Odaklan."}]},
            4: {t:"Pilates", s:"Recov", j:false, pre:["KalÃ§a Flexor"], i:[{n:"Pilates (19:00)",v:"pilates",d:"Esneklik."}]},
            5: {t:"Back & Biceps", s:"Ã‡ekme", j:true, pre:["Omuz Mob."], i:[...muscleDB.back.i, {n:"Curl",v:"arm",d:"Negatif."}]},
            6: {t:"Legs & Shoulders", s:"Kuvvet", j:false, pre:["KalÃ§a Akt."], i:[...muscleDB.legs.i, ...muscleDB.shoulders.i]},
            panic: {t:"Ev Modu", s:"Home", j:false, pre:["Jacks"], i:[{n:"50 ÅÄ±nav",v:"push",d:"Nizami."},{n:"50 Squat",v:"legs",d:"Derin."}]}
        };

        const offSeasonSchedule = JSON.parse(JSON.stringify(seasonSchedule));
        offSeasonSchedule[3] = {t:"CANAVAR MODU", s:"Off-Season", j:true, pre:["Dinamik IsÄ±nma"], i:[{n:"Deadlift",v:"legs",d:"AÄŸÄ±r gir."},{n:"Heavy Rows",v:"pull",d:"SÄ±rtÄ±nÄ± parÃ§ala."},{n:"HIIT",v:"cardio",d:"NabzÄ± patlat."}]};

        const panicPrograms = {
            classic: seasonSchedule.panic,
            micro: {
                t:"Ev Modu Mini", s:"5 Dakika", j:false, pre:["Jacks"],
                i:[
                    {n:"Squat (2x20)", v:"legs", d:"Derin ve kontrollÃ¼."},
                    {n:"ÅÄ±nav (2x10)", v:"push", d:"Plank pozisyonunu koru."}
                ]
            },
            recovery: {
                t:"Recovery Ev Modu", s:"Esneme", j:false, pre:["Dinamik IsÄ±nma"],
                i:[
                    {n:"Nefes & Esneme (10dk)", v:"pilates", d:"YumuÅŸak hareket et, nefese odaklan."}
                ]
            }
        };

        const heatMapVisualMap = {
            push:'chest',
            press:'shoulders',
            pull:'back',
            legs:'legs',
            arm:'arms',
            core:'core',
            cardio:'core',
            pilates:'core'
        };

        let today = new Date();
        let data, stats, settings;
        let timerInt = null, timerSec = 0;
        let breatheInt = null;

        const getK = d => d.toISOString().split('T')[0];

        function defaultDay(){
            return {c:[],s:{},w:{},rpe:{},n:"",wt:0,nutri:{cal:0, pro:0, log:[], supps:[], timing:[]}, panic:false, panicMode:null, readiness:0, bw:0, vol:0};
        }

        function save(){ localStorage.setItem('primeDataV21', JSON.stringify(data)); }
        function saveStats(){
            localStorage.setItem('primeStatsV21', JSON.stringify(stats));
            const h = document.getElementById('userHeight');
            if(h) h.value = stats.height || "";
        }

        function handleStreak(){
            const k = getK(today);
            if(!stats.lastLogin){
                stats.lastLogin = k;
                stats.streak = stats.streak || 1;
                saveStats();
                return;
            }
            if(stats.lastLogin === k) return;
            const last = new Date(stats.lastLogin);
            const diffDays = Math.round((today - last)/(1000*60*60*24));
            if(diffDays === 1){
                stats.streak = (stats.streak || 0) + 1;
            } else if(diffDays > 1){
                stats.streak = 1;
            }
            stats.lastLogin = k;
            saveStats();
        }

        function computeTargets(){
            let weight = stats.lastWeight;
            const k = getK(today);
            if(!weight && data[k] && data[k].bw) weight = data[k].bw;
            weight = parseFloat(weight);
            if(!weight || weight <= 0){
                stats.targetCal = stats.targetCal || 2500;
                stats.targetPro = stats.targetPro || 160;
            } else {
                const goal = (stats.profile && stats.profile.goal) || 'maintain';
                const activity = (stats.profile && stats.profile.activity) || 'medium';
                const actFactor = activity === 'low' ? 1.3 : (activity === 'high' ? 1.7 : 1.5);
                let cal = weight * 24 * actFactor;
                if(goal === 'cut') cal *= 0.85;
                else if(goal === 'gain') cal *= 1.1;
                stats.targetCal = Math.round(cal);
                let proPerKg = 1.6;
                if(goal === 'cut') proPerKg = 2.0;
                else if(goal === 'strength' || goal === 'jump') proPerKg = 1.8;
                stats.targetPro = Math.round(weight * proPerKg);
            }
            saveStats();
            const tCal = stats.targetCal || 2500;
            const tPro = stats.targetPro || 160;
            const calEl = document.getElementById('targetCalDisplay');
            const proEl = document.getElementById('targetProDisplay');
            if(calEl) calEl.innerText = tCal;
            if(proEl) proEl.innerText = tPro + "g";
        }

        function ensureDailyQuests(){
            const k = getK(today);
            if(!stats.daily || stats.daily.date !== k){
                stats.daily = {
                    date: k,
                    quests: [
                        {id:'water2', text:'BugÃ¼n en az 2L su iÃ§', reward:20, done:false},
                        {id:'journal', text:'GÃ¼nÃ¼n sonunda gÃ¼nlÃ¼k not yaz', reward:20, done:false},
                        {id:'session', text:'BugÃ¼n en az 1 antrenman hareketini tamamla', reward:30, done:false}
                    ]
                };
                saveStats();
            }
            renderDailyQuests();
        }

        function renderDailyQuests(){
            const box = document.getElementById('dailyQuestBox');
            if(!box || !stats.daily) return;
            const qs = stats.daily.quests || [];
            box.innerHTML = '<div style="font-size:0.8rem; color:#aaa; margin-bottom:6px;">ğŸ¯ GÃ¼nlÃ¼k GÃ¶revler</div>' +
                qs.map(q=>{
                    const mark = q.done ? 'âœ”' : 'â—‹';
                    const color = q.done ? 'var(--accent)' : '#777';
                    return `<div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; margin-bottom:4px;">
                        <span>${mark} ${q.text}</span>
                        <span style="color:${color}; font-weight:bold;">+${q.reward} XP</span>
                    </div>`;
                }).join('');
        }

        function completeQuest(id){
            if(!stats.daily || !stats.daily.quests) return;
            const q = stats.daily.quests.find(q=>q.id===id);
            if(!q || q.done) return;
            q.done = true;
            addXP(q.reward);
            saveStats();
            renderDailyQuests();
        }

        function getTotalVolumeAll(){
            let sum = 0;
            Object.keys(data || {}).forEach(k=>{
                if(data[k] && typeof data[k].vol === 'number') sum += data[k].vol;
            });
            return sum;
        }

        function calcDayVolumeKey(k){
            const dt = data[k];
            if(!dt) return 0;
            let vol = 0;
            const completed = dt.c || [];
            (completed || []).forEach(idx=>{
                const kg = parseInt(dt.w && dt.w[idx] || 0) || 0;
                const sets = parseInt(dt.s && dt.s[idx] || 3) || 0;
                if(kg > 0 && sets > 0) vol += kg * sets;
            });
            dt.vol = vol;
            return vol;
        }

        function init() {
            try {
                data = JSON.parse(localStorage.getItem('primeDataV21')) || {};
                stats = JSON.parse(localStorage.getItem('primeStatsV21')) || {
                    xp:0,
                    height:0,
                    challenge:{target:1000, current:0, title:"1000 ÅÄ±nav"},
                    streak:0,
                    lastLogin:"",
                    max:{},
                    games:[],
                    heat:{},
                    history:{},
                    pain:[],
                    profile:null,
                    profileCompleted:false,
                    lastWeight:null,
                    targetCal:2500,
                    targetPro:160,
                    achievements:{},
                    daily:null
                };
                settings = JSON.parse(localStorage.getItem('primeSettingsV21')) || {sound:false, inSeason:true};

                if(!stats.heat) stats.heat = {chest:0,back:0,legs:0,shoulders:0,arms:0,core:0};
                if(!stats.achievements) stats.achievements = {};
                const k = getK(today);
                if(!data[k]) data[k] = defaultDay();

                handleStreak();
                computeTargets();

                document.getElementById('dailyQuote').innerHTML = `"${quotes[today.getDate() % quotes.length]}"`;
                document.getElementById('seasonToggle').checked = settings.inSeason;
                document.getElementById('soundToggle').checked = settings.sound;
                document.getElementById('userHeight').value = stats.height || "";

                ensureDailyQuests();

                if(!stats.profile || !stats.profileCompleted){
                    openModal('onboardingModal');
                } else if(data[k].readiness === 0){
                    openModal('readinessModal');
                }

                updateChallengeUI();
                renderFoodList();
                render();
                renderXP();
                renderHeatmap();
                renderGameHistory();
                renderPainMap();
                renderAchievements();
            } catch (e) {
                alert("Veri hatasÄ±. SÄ±fÄ±rlanÄ±yor...");
                if(confirm("KayÄ±tlÄ± verileri temizleyip tekrar baÅŸlatmak ister misin?")){
                    localStorage.removeItem('primeDataV21');
                    localStorage.removeItem('primeStatsV21');
                    localStorage.removeItem('primeSettingsV21');
                    location.reload();
                }
            }
        }

        function render() {
            const k = getK(today);
            const dd = data[k];
            document.getElementById('dateDisplay').innerText = today.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric'});
            const baseProg = settings.inSeason ? seasonSchedule[today.getDay()] : offSeasonSchedule[today.getDay()];
            let p = dd.custom || baseProg;
            if(dd.panic){
                const pmode = dd.panicMode || 'classic';
                p = panicPrograms[pmode] || panicPrograms.classic;
            }

            document.getElementById('progTitle').innerText = p.t;
            document.getElementById('progSub').innerText = p.s;
            document.getElementById('seasonBadge').innerText = settings.inSeason ? "SEZON Ä°Ã‡Ä°" : "OFF-SEASON";
            document.getElementById('readinessBadge').innerText = ["Enerji: ?", "Enerji: ğŸ˜«", "Enerji: ğŸ¥±", "Enerji: ğŸ˜", "Enerji: ğŸ™‚", "Enerji: ğŸ”¥"][dd.readiness];

            // Prehab + pain entegrasyonu
            const phList = document.getElementById('prehabList');
            phList.innerHTML = "";
            let preList = (p.pre ? [...p.pre] : []);
            if(stats.pain && Array.isArray(stats.pain)){
                if(stats.pain.includes('diz')){
                    if(!preList.includes('Patellar Tendon')) preList.push('Patellar Tendon');
                    if(!preList.includes('Tibialis')) preList.push('Tibialis');
                }
                if(stats.pain.includes('bel') || stats.pain.includes('kalca')){
                    if(!preList.includes('KalÃ§a Flexor')) preList.push('KalÃ§a Flexor');
                    if(!preList.includes('KalÃ§a Akt.')) preList.push('KalÃ§a Akt.');
                }
                if(stats.pain.includes('omuz')){
                    if(!preList.includes('Rotator Cuff')) preList.push('Rotator Cuff');
                    if(!preList.includes('Omuz Mob.')) preList.push('Omuz Mob.');
                }
            }
            if(preList) preList.forEach(item => {
                const meta = warmupDB[item] || {d: "HazÄ±rlÄ±k."};
                phList.innerHTML += `<div class="prehab-item">
                    <div>
                        <div style="font-weight:600">${item}</div>
                        <span class="prehab-desc">${meta.d}</span>
                    </div>
                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(item + " exercise")}" target="_blank" class="yt-btn">â–¶</a>
                </div>`;
            });

            const list = document.getElementById('workoutList');
            list.innerHTML='';
            const ddC = dd.c || [];
            const ddW = dd.w || {};
            const ddS = dd.s || {};
            p.i.forEach((it,i) => {
                const chk = ddC.includes(i);
                const kg = parseInt(ddW[i] || 0) || 0;
                const sets = ddS[i] || '';
                const name = it.n.split('(')[0].trim();
                const isPR = kg > (stats.max[name]||0) && kg>0;
                list.innerHTML += `<div class="task-item ${chk?'checked':''}" id="task-${i}">
                    <div class="task-top">
                        <div class="task-visual" onclick="toggleGuide(${i})">${visuals[it.v]||visuals.push}</div>
                        <div class="check-group" onclick="toggle(${i},'${it.isGame?'game':''}',${p.i.length})">
                            <div style="flex:1"><span class="task-name">${name}</span></div>
                            <div class="circle-check"></div>
                        </div>
                        <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(name + " nasÄ±l yapÄ±lÄ±r")}" target="_blank" class="yt-btn">â–¶</a>
                    </div>
                    <div class="guide-text">ğŸ’¡ ${it.d||"KontrollÃ¼."}</div>
                    ${it.v!=='rest' && it.v!=='pilates' && it.v!=='cardio' ? `
                        <div class="input-row">
                            <input class="mini-input" placeholder="Set" value="${sets}" onchange="saveS(${i},this.value)">
                            <input class="mini-input ${isPR?'pr-active':''}" placeholder="Kg" type="number" value="${ddW[i]||''}" onchange="saveW('${name}',${i},this.value,${ddS[i]||3})">
                            <button class="tool-btn" onclick="openCalc(${kg||0})">ğŸ§®</button>
                            <button class="tool-btn" onclick="openHist('${name}')">ğŸ“œ</button>
                        </div>` : ''
                    }
                </div>`;
            });

            const vol = calcDayVolumeKey(k);
            document.getElementById('totalVolume').innerText = vol + " kg";

            const percent = (p.i && p.i.length) ? Math.round((ddC.length / p.i.length) * 100) : 0;
            document.getElementById('progPercent').innerText = "%" + percent;

            updateTrackers(dd);
            updateTrainingAlerts();
        }

        function updateTrainingAlerts(){
            const k = getK(today);
            const dd = data[k];
            const lowEl = document.getElementById('lowEnergyAlert');
            const highEl = document.getElementById('highEnergyAlert');
            lowEl.style.display = 'none';
            highEl.style.display = 'none';
            if(dd.readiness <= 2 && dd.readiness > 0) lowEl.style.display = 'flex';
            if(dd.readiness >= 4) highEl.style.display = 'flex';

            const deloadEl = document.getElementById('deloadAlert');
            const todayDate = new Date(today);
            let last7 = 0, prev7 = 0;
            for(let i=0;i<14;i++){
                const d = new Date(todayDate);
                d.setDate(d.getDate() - i);
                const key = getK(d);
                const v = (data[key] && typeof data[key].vol === 'number') ? data[key].vol : 0;
                if(i < 7) last7 += v; else prev7 += v;
            }
            const avgPrev7 = prev7 / 7;
            if(last7 > 0 && avgPrev7 > 0 && last7 > avgPrev7 * 1.3){
                deloadEl.style.display = 'flex';
            } else {
                deloadEl.style.display = 'none';
            }
        }

        function toggle(i,s,t){
            const k=getK(today);
            const a=data[k].c || (data[k].c = []);
            if(a.includes(i)) {
                a.splice(a.indexOf(i),1);
            } else {
                a.push(i);
                startTimer();
                addXP(10);
                updateHeatmap(i);
                if(s==='game') openModal('gameLogModal');
                if(a.length===t) checkClutch();
                completeQuest('session');
            }
            data[k].c = a;
            data[k].vol = calcDayVolumeKey(k);
            save();
            render();
        }

        function checkClutch(){ if(Math.random()<0.3) { document.getElementById('clutchTaskDisplay').innerText = clutchTasks[Math.floor(Math.random()*clutchTasks.length)]; openModal('clutchModal'); } else showWrapUp(); }
        function completeClutch(){ addXP(100); closeModal('clutchModal'); showWrapUp(); }

        function showWrapUp(){
            const k=getK(today);
            const dt=data[k];
            const vol = dt.vol || calcDayVolumeKey(k);
            document.getElementById('wrapVol').innerText = vol;
            document.getElementById('wrapXP').innerText = "+" + (dt.c.length * 10);

            // HaftalÄ±k Ã¶zet
            let sessions = 0;
            const baseDate = new Date(today);
            for(let i=0;i<7;i++){
                const d = new Date(baseDate);
                d.setDate(d.getDate()-i);
                const key = getK(d);
                if(data[key] && data[key].c && data[key].c.length>0) sessions++;
            }
            document.getElementById('wrapExtras').innerText = `Son 7 gÃ¼nde ${sessions} antrenman gÃ¼nÃ¼ tamamladÄ±n.`;

            const totalVolAll = getTotalVolumeAll();
            if(totalVolAll >= 10000 && !stats.achievements.tenKVolume){
                stats.achievements.tenKVolume = true;
                addXP(100);
                alert("BaÅŸarÄ±m aÃ§Ä±ldÄ±: 10.000 kg toplam yÃ¼k!");
            }
            saveStats();
            renderAchievements();
            openModal('wrapUpModal');
            fireConfetti();
        }

        function addJumpToToday(){
            const k=getK(today);
            const idx=today.getDay();
            const base = settings.inSeason ? seasonSchedule[idx] : offSeasonSchedule[idx];
            let cur=data[k].custom?data[k].custom:base;
            data[k].custom={t:cur.t+" + Jump",s:cur.s,j:true,pre:cur.pre,i:[...cur.i,...jumpR]};
            save();
            render();
            alert("ZÄ±plama Eklendi!");
        }

        function saveW(n,i,v,s){
            const k=getK(today);
            data[k].w[i]=v;
            if(v>(stats.max[n]||0)){
                stats.max[n]=v;
                alert("REKOR! ğŸ†");
                if(!stats.achievements.firstPR){
                    stats.achievements.firstPR = true;
                    addXP(50);
                    alert("BaÅŸarÄ±m aÃ§Ä±ldÄ±: Ä°lk PR!");
                }
            }
            stats.history[n]={w:v,s:s,d:k};
            save();
            saveStats();
            render();
        }

        function saveS(i,v){ data[getK(today)].s[i]=v; save(); }

        function addXP(x){
            stats.xp+=x;
            saveStats();
            renderXP();
        }

        function renderXP(){
            const lvl = Math.floor(stats.xp/1000+1);
            document.getElementById('xpBar').style.width=(stats.xp%1000)/10+"%";
            document.getElementById('xpText').innerText=stats.xp+" XP";
            document.getElementById('currentLvl').innerText="Lvl "+lvl;
            document.getElementById('userRank').innerText = "Seri: " + (stats.streak || 0) + " gÃ¼n";
        }

        function updateTrackers(dd){
            const k = getK(today);
            document.getElementById('waterCount').innerText=dd.wt+" lt";
            document.getElementById('journal').value=dd.n||"";
            document.getElementById('dailyWeight').value=dd.bw||"";
            const cal=dd.nutri?.cal||0;
            const pro=dd.nutri?.pro||0;
            document.getElementById('calStatus').innerText=cal+" kcal";
            document.getElementById('proStatus').innerText=pro+"g";

            const tCal = stats.targetCal || 2500;
            const tPro = stats.targetPro || 160;
            document.getElementById('targetCalDisplay').innerText = tCal;
            document.getElementById('targetProDisplay').innerText = tPro + "g";

            document.getElementById('calText').innerText=`${cal} / ${tCal}`;
            document.getElementById('proText').innerText=`${pro} / ${tPro}g`;
            document.getElementById('calBar').style.width=Math.min((cal/tCal)*100,100)+"%";
            document.getElementById('proBar').style.width=Math.min((pro/tPro)*100,100)+"%";

            const l=document.getElementById('foodLog');
            l.innerHTML="";
            if(dd.nutri?.log) dd.nutri.log.forEach(f=>l.innerHTML+=`<div>â€¢ ${f.n} (${f.c}kcal, ${f.p}g)</div>`);

            const idx = today.getDay();
            const baseProg = settings.inSeason ? seasonSchedule[idx] : offSeasonSchedule[idx];
            let p = dd.custom || baseProg;
            if(dd.panic){
                const pmode = dd.panicMode || 'classic';
                p = panicPrograms[pmode] || panicPrograms.classic;
            }
            if(p.j) document.getElementById('nutrientTimingBox').style.display='block';
            else document.getElementById('nutrientTimingBox').style.display='none';
        }

        function renderFoodList(){
            const g=document.getElementById('foodGrid');
            g.innerHTML="";
            foodDB.forEach((f,i)=>{g.innerHTML+=`<div class="food-item" onclick="addFood(${i})"><b>${f.n}</b><small>${f.c}kcal / ${f.p}g</small></div>`;});
        }

        function ensureNutri(k){
            if(!data[k].nutri) data[k].nutri = {cal:0, pro:0, log:[], supps:[], timing:[]};
            if(!Array.isArray(data[k].nutri.supps)) data[k].nutri.supps = [];
            if(!Array.isArray(data[k].nutri.timing)) data[k].nutri.timing = [];
            if(!Array.isArray(data[k].nutri.log)) data[k].nutri.log = [];
        }

        function addFood(i){
            const f=foodDB[i];
            const k=getK(today);
            ensureNutri(k);
            data[k].nutri.cal+=f.c;
            data[k].nutri.pro+=f.p;
            data[k].nutri.log.push(f);
            save();
            render();
        }

        function addQuickMacros(){
            const c=parseInt(document.getElementById('quickCal').value)||0;
            const p=parseInt(document.getElementById('quickPro').value)||0;
            if(c>0||p>0){
                const k=getK(today);
                ensureNutri(k);
                data[k].nutri.cal+=c;
                data[k].nutri.pro+=p;
                data[k].nutri.log.push({n:"HÄ±zlÄ± Ekleme",c:c,p:p});
                document.getElementById('quickCal').value="";
                document.getElementById('quickPro').value="";
                save();
                render();
            }
        }

        function clearNutrition(){
            if(confirm("Beslenme listesi silinsin mi?")){
                const k=getK(today);
                ensureNutri(k);
                const supps = data[k].nutri.supps;
                const timing = data[k].nutri.timing;
                data[k].nutri={cal:0,pro:0,log:[],supps:supps,timing:timing};
                save();
                render();
            }
        }

        function renderHeatmap(){
            const c={low:'#333',med:'#ffd60a',high:'#ff453a'};
            const setFill=(id,val)=>{
                const el=document.getElementById(id);
                if(!el)return;
                if(val>20)el.style.fill=c.high;
                else if(val>5)el.style.fill=c.med;
                else el.style.fill=c.low;
            };
            setFill('svg-chest',stats.heat.chest);
            setFill('svg-shoulders',stats.heat.shoulders);
            setFill('svg-arms',stats.heat.arms);
            setFill('svg-legs',stats.heat.legs);
            setFill('svg-core',stats.heat.core);

            const legAlert = document.getElementById('legAlert');
            const totalUpper = (stats.heat.chest||0)+(stats.heat.shoulders||0)+(stats.heat.arms||0);
            if(totalUpper>0 && (stats.heat.legs||0) < totalUpper*0.4){
                legAlert.style.display = 'flex';
            } else {
                legAlert.style.display = 'none';
            }
        }

        function updateHeatmap(i){
            const k=getK(today);
            const dd=data[k];
            const baseProg = settings.inSeason ? seasonSchedule[today.getDay()] : offSeasonSchedule[today.getDay()];
            let p = dd.custom || baseProg;
            if(dd.panic){
                const pmode = dd.panicMode || 'classic';
                p = panicPrograms[pmode] || panicPrograms.classic;
            }
            const ex = p && p.i && p.i[i];
            if(!ex) return;
            const key = heatMapVisualMap[ex.v] || 'core';
            stats.heat[key] = (stats.heat[key]||0)+1;
            saveStats();
            renderHeatmap();
        }

        function renderGameHistory(){
            const d=document.getElementById('gameHistory');
            d.innerHTML="";
            if(!stats.games || stats.games.length===0){
                d.innerHTML = '<div style="font-size:0.8rem; color:#777;">HenÃ¼z kayÄ±tlÄ± maÃ§ yok.</div>';
                return;
            }
            let totalPts=0,totalAst=0,maxPts=0;
            stats.games.forEach(g=>{
                const pts = Number(g.pts)||0;
                const ast = Number(g.ast)||0;
                totalPts += pts;
                totalAst += ast;
                if(pts>maxPts) maxPts = pts;
            });
            const count = stats.games.length;
            const avgPts = (totalPts/count).toFixed(1);
            const avgAst = (totalAst/count).toFixed(1);
            d.innerHTML += `<div style="background:#111; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #444; font-size:0.8rem;">
                Ortalama: ${avgPts} SayÄ± / ${avgAst} Asist<br>
                En yÃ¼ksek skor: ${maxPts} SayÄ±
            </div>`;
            stats.games.slice(-5).reverse().forEach(g=>{
                d.innerHTML+=`<div style="background:#111; padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #333; font-size:0.8rem;">${g.date} - ${g.pts} SayÄ± / ${g.ast} Asist</div>`;
            });
        }

        function renderAchievements(){
            const box = document.getElementById('achievementsBox');
            if(!box) return;
            const a = stats.achievements || {};
            const items = [];
            if(a.firstPR) items.push("ğŸ† Ä°lk PR");
            if(a.tenKVolume) items.push("ğŸ’ª 10.000 kg Toplam YÃ¼k");
            if(a.tenGames) items.push("ğŸ€ 10 MaÃ§ KaydÄ±");
            if(items.length===0){
                box.innerHTML = '<div style="font-size:0.8rem; color:#777;">HenÃ¼z kilitlenen baÅŸarÄ± yok.</div>';
            } else {
                box.innerHTML = items.map(t=>`<div style="background:#111; padding:8px; border-radius:6px; margin-bottom:4px; border:1px solid #333; font-size:0.8rem;">${t}</div>`).join('');
            }
        }

        function openModal(id){document.getElementById(id).classList.add('open');}
        function closeModal(id){document.getElementById(id).classList.remove('open');}

        function switchToolTab(t, el){
            document.querySelectorAll('.tool-content').forEach(e=>e.style.display='none');
            document.getElementById('tool-'+t).style.display='block';
            document.querySelectorAll('.n-tab').forEach(e=>e.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        function toggleGuide(i){ document.getElementById(`task-${i}`).classList.toggle('show-guide'); }

        function startTimer(){
            const el=document.getElementById('timerFloat');
            el.classList.add('active');
            if(timerInt) clearInterval(timerInt);
            timerSec=90;
            updT();
            timerInt=setInterval(()=>{
                timerSec--;
                updT();
                if(timerSec<=0){
                    stopTimer();
                    notify();
                }
            },1000);
        }

        function addTimer(sec){
            timerSec += sec;
            if(timerSec < 0) timerSec = 0;
            updT();
        }

        function stopTimer(){
            if(timerInt) clearInterval(timerInt);
            timerInt = null;
            document.getElementById('timerFloat').classList.remove('active');
        }

        function updT(){
            const m=Math.floor(timerSec/60), s=timerSec%60;
            document.getElementById('timerDisplay').innerText=`0${m}:${s<10?'0'+s:s}`;
        }

        function notify(){
            if(settings.sound && 'speechSynthesis' in window){
                const u=new SpeechSynthesisUtterance("SÃ¼re doldu!");
                u.lang='tr-TR';
                window.speechSynthesis.speak(u);
            } else if(navigator.vibrate){
                navigator.vibrate([200,100,200]);
            }
        }

        function addWater(){
            const k=getK(today);
            data[k].wt+=0.5;
            save();
            if(data[k].wt >= 2) completeQuest('water2');
            render();
        }

        function saveData(){
            const k = getK(today);
            if(!data[k]) data[k] = defaultDay();
            data[k].n = document.getElementById('journal').value;
            const bw = document.getElementById('dailyWeight').value;
            data[k].bw = bw;
            if(bw){
                stats.lastWeight = bw;
                saveStats();
                computeTargets();
            }
            if((data[k].n || '').trim().length > 0){
                completeQuest('journal');
            }
            save();
        }

        function setReadiness(v){
            data[getK(today)].readiness=v;
            save();
            closeModal('readinessModal');
            render();
        }

        function togglePanic(){
            openModal('panicModal');
        }

        function setPanicMode(mode){
            const k=getK(today);
            data[k].panic = true;
            data[k].panicMode = mode;
            save();
            closeModal('panicModal');
            render();
        }

        function disablePanic(){
            const k=getK(today);
            data[k].panic = false;
            data[k].panicMode = null;
            save();
            closeModal('panicModal');
            render();
        }

        function changeDate(d){
            today.setDate(today.getDate()+d);
            const k = getK(today);
            if(!data[k]) data[k] = defaultDay();
            init();
        }

        function toggleSupp(s){
            const k=getK(today);
            ensureNutri(k);
            const arr = data[k].nutri.supps;
            if(arr.includes(s)) data[k].nutri.supps = arr.filter(x=>x!==s);
            else arr.push(s);
            save();
            render();
        }

        function toggleTiming(t){
            const k=getK(today);
            ensureNutri(k);
            const arr = data[k].nutri.timing;
            if(arr.includes(t)) data[k].nutri.timing = arr.filter(x=>x!==t);
            else arr.push(t);
            save();
            render();
        }

        function calc1RM(){
            const w=parseFloat(document.getElementById('rmWeight').value);
            const r=parseFloat(document.getElementById('rmReps').value);
            if(w&&r)document.getElementById('rmResult').innerText=Math.round(w*(1+r/30))+" kg";
        }

        function openCalc(kg){
            document.getElementById('plateTarget').value=kg;
            calcPlates();
            openModal('plateModal');
        }

        function calcPlates(){
            const t=parseFloat(document.getElementById('plateTarget').value);
            const vis=document.getElementById('plateVisual');
            vis.innerHTML='';
            if(!t||t<=20)return;
            let w=(t-20)/2;
            [25,20,15,10,5,2.5,1.25].forEach(p=>{
                while(w>=p){
                    w-=p;
                    vis.innerHTML+=`<div class="plate" style="width:${28+p}px; background:${p>=25?'#ff3b30':(p>=20?'#0a84ff':(p>=10?'#32d74b':'#ffd60a'))}">${p}</div>`;
                }
            });
        }

        function openHist(n){
            const h=stats.history[n];
            document.getElementById('histTitle').innerText=n+" GeÃ§miÅŸi";
            document.getElementById('histList').innerText=h?`Son: ${h.w}kg x ${h.s} (${h.d})`:"Veri yok.";
            openModal('historyModal');
        }

        function generateMenu(){
            const r=a=>a[Math.floor(Math.random()*a.length)];
            const m1=r(foodDB.filter(f=>f.n.includes('Yumurta')||f.n.includes('Yulaf')));
            const m2=r(foodDB.filter(f=>f.n.includes('Tavuk')||f.n.includes('Ton')));
            const m3=r(foodDB.filter(f=>f.n.includes('Pilav')||f.n.includes('Makarna')));
            document.getElementById('menuResult').innerHTML=`<div style="background:#222; padding:15px; margin-top:15px;"><b>KahvaltÄ±:</b> ${m1.n}<br><b>Ã–ÄŸle:</b> ${m2.n}<br><b>AkÅŸam:</b> ${m3.n}</div>`;
        }

        function togglePain(p){
            if(!stats.pain) stats.pain = [];
            if(stats.pain.includes(p)) stats.pain = stats.pain.filter(x => x !== p);
            else stats.pain.push(p);
            saveStats();
            renderPainMap();
            render();
        }

        function renderPainMap(){
            document.querySelectorAll('.pain-part').forEach(el => el.classList.remove('active'));
            if(stats.pain) stats.pain.forEach(p => {
                const el = document.querySelector(`.pain-part[onclick="togglePain('${p}')"]`);
                if(el) el.classList.add('active');
            });
        }

        function toggleSeason(){
            settings.inSeason = document.getElementById('seasonToggle').checked;
            localStorage.setItem('primeSettingsV21', JSON.stringify(settings));
            render();
        }

        function toggleSound(){
            settings.sound = document.getElementById('soundToggle').checked;
            localStorage.setItem('primeSettingsV21', JSON.stringify(settings));
        }

        function resetApp(){
            if(confirm("TÃ¼m veriler silinsin mi?")){
                localStorage.removeItem('primeDataV21');
                localStorage.removeItem('primeStatsV21');
                localStorage.removeItem('primeSettingsV21');
                location.reload();
            }
        }

        function startBreathing(){
            const el = document.getElementById('breathCircle');
            const txt = document.getElementById('breathText');
            document.getElementById('zoneModal').classList.add('zone-active');
            let phase = 0;
            if(breatheInt) clearInterval(breatheInt);
            const cycle = () => {
                if(phase===0){ el.innerText="AL"; el.style.transform="scale(1.5)"; txt.innerText="HavayÄ± doldur"; }
                else if(phase===1){ el.innerText="TUT"; txt.innerText="Nefesi tut"; }
                else if(phase===2){ el.innerText="VER"; el.style.transform="scale(1)"; txt.innerText="YavaÅŸÃ§a ver"; }
                else if(phase===3){ el.innerText="TUT"; txt.innerText="BoÅŸlukta bekle"; }
                phase = (phase+1)%4;
            };
            cycle();
            breatheInt = setInterval(cycle, 4000);
        }

        function closeZone(){
            if(breatheInt) clearInterval(breatheInt);
            closeModal('zoneModal');
        }

        function saveGameLog(){
            const p=document.getElementById('gamePoints').value;
            const a=document.getElementById('gameAssists').value;
            if(p||a){
                stats.games.push({date:getK(today), pts:p||0, ast:a||0});
                if(stats.games.length >= 10 && !stats.achievements.tenGames){
                    stats.achievements.tenGames = true;
                    addXP(50);
                    alert("BaÅŸarÄ±m aÃ§Ä±ldÄ±: 10 maÃ§ kaydÄ±!");
                }
                saveStats();
                closeModal('gameLogModal');
                renderGameHistory();
                renderAchievements();
            }
        }

        function fireConfetti(){
            const c=document.getElementById('confetti');
            const x=c.getContext('2d');
            c.width=window.innerWidth;
            c.height=window.innerHeight;
            let p=[];
            for(let i=0;i<60;i++)p.push({x:Math.random()*c.width,y:-10,v:Math.random()*5+2,c:'hsl('+Math.random()*360+',100%,50%)'});
            function l(){
                x.clearRect(0,0,c.width,c.height);
                let a=false;
                p.forEach(o=>{
                    o.y+=o.v;
                    if(o.y<c.height){
                        a=true;
                        x.fillStyle=o.c;
                        x.fillRect(o.x,o.y,5,5);
                    }
                });
                if(a)requestAnimationFrame(l);
            }
            l();
        }

        function exportData() {
            const d = {data: data, stats: stats, settings: settings};
            const b = new Blob([JSON.stringify(d)], {type: 'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = 'prime_backup.json';
            a.click();
        }

        function importData(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = (e) => {
                const d = JSON.parse(e.target.result);
                localStorage.setItem('primeDataV21', JSON.stringify(d.data));
                localStorage.setItem('primeStatsV21', JSON.stringify(d.stats));
                localStorage.setItem('primeSettingsV21', JSON.stringify(d.settings));
                location.reload();
            };
            r.readAsText(f);
        }

        function saveProfile(){
            const goal = document.getElementById('obGoal').value;
            const equip = document.getElementById('obEquip').value;
            const activity = document.getElementById('obActivity').value;
            stats.profile = {goal, equip, activity};
            stats.profileCompleted = true;
            saveStats();
            computeTargets();
            closeModal('onboardingModal');
            const k = getK(today);
            if(data[k].readiness === 0){
                openModal('readinessModal');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
