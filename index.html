<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>PRIME v23.0 Stable</title>

    <style>
        /* --- CORE DESIGN --- */
        :root {
            --bg: #000000;
            --card: #161618;
            --text: #ffffff;
            --muted: #8e8e93;
            --accent: #32d74b;
            --blue: #0a84ff;
            --danger: #ff453a;
            --warn: #ff9f0a;
            --purple: #bf5af2;
            --gold: #ffd60a;
            --glass: rgba(22, 22, 24, 0.95);
            --radius: 18px;
        }
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            padding-top: env(safe-area-inset-top);
            padding-bottom: 120px;
            user-select: none;
        }

        /* --- LAYERING --- */
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 0;
        }
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding: 10px 20px;
        }
        .container {
            position: relative;
            z-index: 10;
            padding: 0 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid #333;
            display: flex;
            justify-content: space-around;
            padding: 12px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            z-index: 200;
        }

        /* HEADER */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .app-title {
            font-size: 1.4rem;
            font-weight: 900;
            font-style: italic;
            letter-spacing: -1px;
        }
        .xp-container {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--blue));
            width: 0%;
            transition: width 0.5s ease;
        }
        .level-badge {
            font-size: 0.7rem;
            color: var(--blue);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            gap: 6px;
        }
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            position: relative;
            z-index: 101;
        }
        .challenge-badge {
            background: linear-gradient(90deg, #ff9f0a, #ff3b30);
            color: #fff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 0 10px rgba(255, 159, 10, 0.3);
            cursor: pointer;
        }

        /* ALERTS */
        .alert-box {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 16px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: fadeIn 0.5s;
            border: 1px solid transparent;
            position: relative;
            z-index: 15;
        }
        .alert-low {
            background: rgba(10, 132, 255, 0.15);
            border-color: var(--blue);
            color: var(--blue);
        }
        .alert-high {
            background: rgba(255, 214, 10, 0.15);
            border-color: var(--gold);
            color: var(--gold);
        }
        .alert-deload {
            background: rgba(255, 69, 58, 0.15);
            border-color: var(--danger);
            color: var(--danger);
        }
        .alert-imbalance {
            background: rgba(255, 159, 10, 0.15);
            border-color: var(--warn);
            color: var(--warn);
            display: none;
        }

        /* CARDS & BOXES */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            border: 1px solid #2c2c2e;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .box-header {
            font-weight: bold;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prehab-box {
            background: rgba(10, 132, 255, 0.1);
            border: 1px solid rgba(10, 132, 255, 0.3);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
        }
        .prehab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(10,132,255,0.2);
            font-size: 0.9rem;
        }
        .prehab-item:last-child {
            border-bottom: none;
        }
        .prehab-desc {
            font-size: 0.75rem;
            color: #aaa;
            display: block;
            margin-top: 2px;
        }

        /* TASK ITEMS */
        .task-item {
            padding: 16px 0;
            border-bottom: 1px solid #2a2a2a;
            position: relative;
        }
        .task-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .task-visual {
            width: 50px;
            height: 50px;
            background: #252527;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 1px solid #333;
            cursor: pointer;
        }
        .task-visual svg {
            width: 30px;
            height: 30px;
            fill: #fff;
        }
        .checked .task-visual svg {
            fill: var(--accent);
        }
        .check-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            cursor: pointer;
        }
        .circle-check {
            width: 24px;
            height: 24px;
            border: 2px solid #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: 0.2s;
        }
        .checked .circle-check {
            background: var(--accent);
            border-color: var(--accent);
        }
        .task-name {
            font-size: 1rem;
            font-weight: 600;
            transition: 0.2s;
            line-height: 1.3;
        }
        .checked .task-name {
            color: var(--muted);
            text-decoration: line-through;
        }
        .guide-text {
            font-size: 0.8rem;
            color: var(--blue);
            margin-top: 5px;
            display: none;
            background: rgba(10, 132, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
        }
        .task-item.show-guide .guide-text {
            display: block;
            animation: fadeIn 0.3s;
        }
        .alt-text {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 4px;
        }
        .alt-text a {
            color: var(--gold);
            text-decoration: none;
            margin-right: 4px;
            font-weight: 600;
        }

        .yt-btn {
            background: #222;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: bold;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
            z-index: 20;
        }

        /* INPUTS */
        .input-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-left: 66px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 20;
        }
        .mini-input {
            background: #000;
            border: 1px solid #333;
            color: #fff;
            width: 65px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            -webkit-appearance: none;
        }
        .tool-btn {
            background: #222;
            border: 1px solid #333;
            color: var(--muted);
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .pr-active {
            border-color: var(--gold) !important;
            color: var(--gold) !important;
            box-shadow: 0 0 10px rgba(255, 214, 10, 0.3);
        }

        /* RPE */
        .rpe-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding-left: 66px;
            opacity: 0.6;
            transition: 0.3s;
            position: relative;
            z-index: 20;
            font-size: 0.75rem;
            color: #aaa;
        }
        .rpe-container.active {
            opacity: 1;
        }
        .rpe-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 5px;
            background: #333;
            outline: none;
        }
        .rpe-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
        }

        /* TOGGLES */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            margin-bottom: 15px;
            gap: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--blue);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 300;
            align-items: flex-end;
            backdrop-filter: blur(5px);
        }
        .modal.open {
            display: flex;
        }
        .sheet {
            background: #1c1c1e;
            width: 100%;
            border-radius: 24px 24px 0 0;
            padding: 30px 25px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            border-top: 1px solid #333;
            position: relative;
            z-index: 301;
        }
        .full-modal {
            align-items: center;
            justify-content: center;
        }
        .full-modal .sheet {
            border-radius: 0;
            width: 100%;
            height: 100%;
            max-height: 100%;
            max-width: 100%;
            padding-top: env(safe-area-inset-top);
        }
        .close-sticky {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #fff;
            backdrop-filter: blur(10px);
            border: 1px solid #444;
            cursor: pointer;
        }

        /* UTILS & NUTRITION */
        .tab-btn {
            font-size: 1.7rem;
            opacity: 0.5;
            transition: 0.2s;
            cursor: pointer;
        }
        .tab-btn.active {
            opacity: 1;
            transform: scale(1.1);
            color: var(--accent);
        }
        .timer-float {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: #1c1c1e;
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 250;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            transition: 0.4s;
        }
        .timer-float.active {
            transform: translateX(-50%) translateY(0);
        }
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .track-box {
            background: #111;
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #333;
        }
        .track-val {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fff;
        }
        .nutri-container {
            padding-top: 20px;
            padding-bottom: 80px;
        }
        .nutri-tabs {
            display: flex;
            background: #111;
            padding: 4px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid #333;
        }
        .n-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #777;
            transition: 0.2s;
            font-weight: bold;
            cursor: pointer;
        }
        .n-tab.active {
            background: #222;
            color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .macro-bar-container {
            margin-bottom: 20px;
            background: #111;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
        }
        .macro-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }
        .progress-track {
            width: 100%;
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s;
        }
        .food-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-bottom: 20px;
        }
        .food-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        .food-item:active {
            transform: scale(0.98);
            background: #222;
        }
        .supp-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap:10px;
            margin-bottom: 15px;
        }
        .supp-icon {
            background: #222;
            border: 1px solid #333;
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0.5;
            transition: 0.3s;
            text-align: center;
        }
        .supp-icon.active {
            opacity: 1;
            border-color: var(--blue);
            background: rgba(10, 132, 255, 0.1);
            box-shadow: 0 0 10px rgba(10, 132, 255, 0.3);
        }
        .plate-visual {
            display: flex;
            gap: 2px;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
            margin-top: 15px;
        }
        .plate {
            height: 100%;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #000;
            font-weight: bold;
        }

        /* ANATOMY & BUTTONS */
        .anatomy-container {
            position: relative;
            width: 150px;
            height: 260px;
            margin: 20px auto;
        }
        .anatomy-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .muscle-path {
            fill: #333;
            stroke: #222;
            stroke-width: 1;
            transition: fill 0.5s;
        }
        .pain-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }
        .pain-part {
            padding: 8px 16px;
            background: #222;
            border: 1px solid #333;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .pain-part.active {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        .action-btn {
            width: 100%;
            margin-top: 10px;
            padding: 14px;
            background: #222;
            border: 1px solid #333;
            color: var(--text);
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            position: relative;
            z-index: 10;
        }
        .action-btn:active {
            background: #333;
        }
        .btn-jump {
            border-color: var(--purple);
            color: var(--purple);
            background: rgba(191, 90, 242, 0.1);
        }
        .spin-btn {
            width: 100%;
            padding: 14px;
            background: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity:0; transform:translateY(-10px); }
            to { opacity:1; transform:translateY(0); }
        }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>

    <header>
        <div class="header-top">
            <div style="display:flex; flex-direction:column">
                <div class="app-title">PRIME v23.0 <span style="font-size:0.8rem; color:var(--accent)">Stable</span></div>
                <div style="font-size:0.6rem; letter-spacing:2px; color:var(--blue); font-weight:bold" id="seasonBadge">SEZON ƒ∞√áƒ∞</div>
            </div>
            <div style="display:flex; gap:15px; align-items: center;">
                <div class="challenge-badge" onclick="openModal('challengeModal')">üèÜ <span id="challengeShort">0/1000</span></div>
                <button class="icon-btn" onclick="openModal('zoneModal')">üßò</button>
                <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="xp-container"><div class="xp-fill" id="xpBar"></div></div>
        <div class="level-badge">
            <span id="currentLvl">Lvl 1</span>
            <span id="userRank">Rookie</span>
            <span id="xpText">0 XP</span>
        </div>
    </header>

    <div class="quote-box" id="dailyQuote" style="text-align:center; padding:15px; font-style:italic; color:#888; font-size:0.9rem;">...</div>

    <div class="date-strip" style="display:flex; justify-content:space-between; align-items:center; padding:0 16px; margin-bottom:15px; position:relative; z-index:10;">
        <div class="nav-arrow" onclick="changeDate(-1)" style="font-size:1.5rem; padding:10px; cursor:pointer;">‚ùÆ</div>
        <div style="font-weight:700; font-size:1.1rem;" id="dateDisplay">Bug√ºn</div>
        <div class="nav-arrow" onclick="changeDate(1)" style="font-size:1.5rem; padding:10px; cursor:pointer;">‚ùØ</div>
    </div>

    <div class="container">
        <div class="alert-box alert-deload" id="deloadAlert" style="display:none;">
            <span>‚ö†Ô∏è</span>
            <div><b>Yorgunluk Birikimi!</b><br>Son 7 g√ºnde y√ºk √ßok y√ºksek. Bu hafta %30‚Äì50 hacim azalt, tekniƒüe odaklan.</div>
        </div>
        <div class="alert-box alert-low" id="lowEnergyAlert" style="display:none;">
            <span>üê¢</span>
            <div><b>HAFƒ∞F ANTRENMAN √ñNERƒ∞Sƒ∞</b><br>Uyku / enerji d√º≈ü√ºk g√∂r√ºn√ºyor. Hareketleri temiz yap, aƒüƒ±rlƒ±ƒüƒ± zorlaman ≈üart deƒüil.</div>
        </div>
        <div class="alert-box alert-high" id="highEnergyAlert" style="display:none;">
            <span>üöÄ</span>
            <div><b>REKOR MODU A√áIK!</b><br>Uyku ve hazƒ±rbulunu≈üluk iyi. Bir ana harekette PR kovalayabilirsin.</div>
        </div>

        <div class="prehab-box" id="prehabSection">
            <div class="box-header" style="color:var(--blue)">üõ°Ô∏è Sakatlƒ±k √ñnleme & Isƒ±nma</div>
            <div id="prehabList"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <div>
                    <h2 style="margin:0; font-size:1.3rem" id="progTitle">...</h2>
                    <small style="color:var(--muted)" id="progSub">...</small>
                    <div id="focusBadge" style="font-size:0.7rem; color:var(--purple); margin-top:2px;"></div>
                    <div id="readinessBadge" style="font-size:0.65rem; background:#222; display:inline-block; padding:2px 6px; border-radius:4px; margin-top:4px; color:#aaa">Enerji: ?</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:1.5rem; font-weight:900; color:var(--accent)" id="progPercent">%0</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:4px">Y√úK: <span id="totalVolume" style="color:#fff; font-weight:bold">0 kg</span></div>
                </div>
            </div>

            <div id="workoutList"></div>

            <button class="action-btn btn-jump" onclick="addJumpToToday()">üöÄ + Anlƒ±k Zƒ±plama Ekle</button>

            <div class="finisher-box" style="margin-top:20px; position:relative; z-index:10;">
                <button class="spin-btn" onclick="spinFinisher()">üé≤ Cila (Finisher) √áevir</button>
                <div class="finisher-result" id="finisherResult" style="margin-top:10px; font-weight:bold; color:var(--purple); display:none; text-align:center;">...</div>
                <div style="margin-top:10px; font-size:0.7rem; color:#666; text-align:center;">
                    <label><input type="radio" name="fType" value="gym" checked> Salon</label>
                    <label style="margin-left:10px"><input type="radio" name="fType" value="basket"> Saha</label>
                </div>
            </div>
            <button class="action-btn" onclick="openModal('builderModal')" style="margin-top:15px; color:var(--blue)">üõ†Ô∏è Programƒ± Deƒüi≈ütir</button>
        </div>

        <div class="card tracker-section">
            <h3 style="margin:0 0 15px 0">üîã G√ºnl√ºk Takip</h3>
            <div class="grid-3">
                <div class="track-box" onclick="addWater()">
                    <div class="track-val" id="waterCount">0 lt</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">SU</div>
                </div>
                <div class="track-box" onclick="openModal('nutriModal')">
                    <div class="track-val" id="calStatus">0</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">KALORƒ∞</div>
                </div>
                <div class="track-box" id="proBox" style="border-color:#333" onclick="openModal('nutriModal')">
                    <div class="track-val" id="proStatus">0g</div>
                    <div style="font-size:0.7rem; color:#777; margin-top:5px">PROTEƒ∞N</div>
                </div>
            </div>
            <textarea id="journal" style="width:100%; background:#111; color:#fff; border:1px solid #333; border-radius:12px; padding:15px; min-height:80px;" placeholder="Notlar..." oninput="saveData()"></textarea>
        </div>
    </div>

    <div class="timer-float" id="timerFloat">
        <div style="font-size:0.7rem; color:var(--accent); font-weight:bold">REST</div>
        <div class="timer-val" id="timerDisplay">01:30</div>
        <button class="icon-btn" onclick="addTimer(10)" style="color:#fff; font-size:1.1rem">+10</button>
        <button class="icon-btn" onclick="stopTimer()" style="color:#fff; font-size:1.1rem">‚úï</button>
    </div>

    <div class="bottom-bar">
        <div class="tab-btn" onclick="togglePanic()">üè†</div>
        <div class="tab-btn" onclick="openModal('nutriModal')">üçé</div>
        <div class="tab-btn active" onclick="window.scrollTo(0,0)">üí™</div>
        <div class="tab-btn" onclick="openModal('statsModal')">üìä</div>
    </div>

    <div class="modal full-modal" id="clutchModal">
        <div class="sheet clutch-modal" style="text-align:center;">
            <div style="font-size:3rem; margin-bottom:10px">üî•</div>
            <h2 class="clutch-title">CLUTCH TIME!</h2>
            <p style="color:#ccc; margin-top:10px">Ma√ßƒ±n son topu elinde.</p>
            <div class="clutch-task" id="clutchTaskDisplay">...</div>
            <div style="color:var(--gold); font-size:0.9rem; margin-bottom:20px">√ñd√ºl: 2x XP</div>
            <button onclick="completeClutch()" class="spin-btn" style="width:100%; justify-content:center; background:var(--danger); margin-bottom:10px">YAPTIM (+XP)</button>
            <button onclick="closeModal('clutchModal'); showWrapUp()" style="background:none; border:none; color:#777; text-decoration:underline">Pas Ge√ß</button>
        </div>
    </div>

    <div class="modal full-modal" id="zoneModal">
        <div class="sheet" style="text-align:center">
            <div style="display:flex; justify-content:space-between;">
                <h2>Zone Modu</h2>
                <span onclick="closeZone()" style="cursor:pointer;">‚úï</span>
            </div>
            <p style="color:#777; font-size:0.9rem">Kutu Nefes: 4 Al - 4 Tut - 4 Ver - 4 Tut</p>
            <div class="breathing-circle" id="breathCircle" style="width:150px; height:150px; border:4px solid #333; border-radius:50%; margin:30px auto; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-weight:bold; color:var(--blue); transition:all 4s ease-in-out;">BA≈ûLA</div>
            <div class="breathing-text" id="breathText">Odaklan...</div>
            <button onclick="startBreathing()" class="spin-btn" style="margin-top:30px; width:100%; justify-content:center">Ba≈ülat</button>
        </div>
    </div>

    <div class="modal full-modal" id="wrapUpModal">
        <div class="sheet" style="text-align:center; border-color:var(--gold)">
            <div style="font-size:3rem; margin-bottom:10px">üéâ</div>
            <h2 style="color:var(--gold); font-size:1.8rem; margin:0">ANTRENMAN TAMAMLANDI!</h2>
            <div class="wrap-stats" style="display:flex; justify-content:space-around; margin:20px 0;">
                <div class="wrap-box">
                    <div class="wrap-val" id="wrapVol" style="font-size:1.6rem; font-weight:bold;">0</div>
                    <div style="font-size:0.8rem; color:#777">Toplam Y√ºk (Kg)</div>
                </div>
                <div class="wrap-box">
                    <div class="wrap-val" id="wrapXP" style="font-size:1.6rem; font-weight:bold;">0</div>
                    <div style="font-size:0.8rem; color:#777">Kazanƒ±lan XP</div>
                </div>
            </div>
            <button onclick="closeModal('wrapUpModal')" class="spin-btn" style="width:100%; justify-content:center; background:#333; border:1px solid #555">Kapat</button>
        </div>
    </div>

    <div class="modal full-modal" id="nutriModal">
        <div class="sheet nutri-container">
            <div class="close-sticky" onclick="closeModal('nutriModal')">‚úï</div>
            <h2 style="padding:0 20px">Beslenme Merkezi</h2>
            <div style="padding:0 20px">
                <div class="nutri-tabs">
                    <div class="n-tab active" onclick="switchToolTab('track')">Takip</div>
                    <div class="n-tab" onclick="switchToolTab('wizard')">Sihirbaz</div>
                    <div class="n-tab" onclick="switchToolTab('1rm')">1RM & Hesap</div>
                </div>

                <div id="tool-track" class="tool-content active">
                    <div style="text-align:center;margin-bottom:15px">
                        HEDEF: <span id="targetCalDisplay" style="color:var(--gold);font-weight:bold">--</span> kcal /
                        <span style="color:var(--accent);font-weight:bold">160g</span> Prot
                    </div>
                    <div class="macro-bar-container">
                        <div class="macro-label"><span>Kalori</span><span id="calText">0</span></div>
                        <div class="progress-track"><div class="progress-fill" id="calBar" style="width:0%;background:var(--gold)"></div></div>
                    </div>
                    <div class="macro-bar-container">
                        <div class="macro-label"><span>Protein</span><span id="proText">0</span></div>
                        <div class="progress-track"><div class="progress-fill" id="proBar" style="width:0%;background:var(--accent)"></div></div>
                    </div>
                    <div id="macroHint" style="margin:10px 0 15px; font-size:0.8rem; color:#aaa;"></div>
                    <div style="display:flex; gap:10px; margin-bottom:15px; background:#1a1a1a; padding:10px; border-radius:12px; border:1px solid #333;">
                        <input type="number" min="0" id="quickCal" class="mini-input" style="flex:1; width:auto;" placeholder="Kcal">
                        <input type="number" min="0" id="quickPro" class="mini-input" style="flex:1; width:auto;" placeholder="Prot (g)">
                        <button class="tool-btn" style="width:50px" onclick="addQuickMacros()">+</button>
                    </div>
                    <h4 style="margin-bottom:10px; color:#888;">Supplementler</h4>
                    <div class="supp-grid">
                        <div class="supp-icon" id="supp-creatine" onclick="toggleSupp('creatine')">üß™<br>Kreatin</div>
                        <div class="supp-icon" id="supp-omega" onclick="toggleSupp('omega')">üêü<br>Omega3</div>
                        <div class="supp-icon" id="supp-multi" onclick="toggleSupp('multi')">üíä<br>Vitamin</div>
                        <div class="supp-icon" id="supp-caffeine" onclick="toggleSupp('caffeine')">‚òï<br>Kafein</div>
                    </div>
                    <div class="timing-box" id="nutrientTimingBox" style="display:none; background:rgba(255,214,10,0.1); padding:10px; border-radius:10px; margin-bottom:15px;">
                        <div style="font-weight:bold; color:var(--gold); margin-bottom:5px">‚ö° MA√á G√úN√ú ZAMANLAMASI</div>
                        <div class="timing-item" onclick="toggleTiming('t1')" id="time-t1" style="padding:5px; cursor:pointer;">üî≤ Ma√ßtan 3-4 Saat √ñnce: Karbonhidrat</div>
                        <div class="timing-item" onclick="toggleTiming('t2')" id="time-t2" style="padding:5px; cursor:pointer;">üî≤ Ma√ßtan 1 Saat √ñnce: Hafif Atƒ±≈ütƒ±rmalƒ±k</div>
                        <div class="timing-item" onclick="toggleTiming('t3')" id="time-t3" style="padding:5px; cursor:pointer;">üî≤ Ma√ß Sonrasƒ± (30dk): Protein & ≈ûeker</div>
                    </div>
                    <h4 style="margin-bottom:10px; color:#888;">Hƒ±zlƒ± Men√º</h4>
                    <div class="food-grid" id="foodGrid"></div>
                    <div id="foodLog" class="food-log-list" style="margin-top:15px; font-size:0.8rem; color:#777;"></div>
                    <button onclick="clearNutrition()" style="width:100%; margin-top:20px; padding:10px; background:none; border:1px solid #333; color:#666; border-radius:8px;">Listeyi Temizle</button>
                </div>

                <div id="tool-wizard" class="tool-content" style="display:none;">
                    <button class="spin-btn" style="width:100%; justify-content:center; margin-bottom:15px" onclick="generateMenu()">üé≤ Rastgele G√ºnl√ºk Men√º Olu≈ütur</button>
                    <div id="menuResult"></div>
                </div>

                <div id="tool-1rm" class="tool-content" style="display:none;">
                    <div style="display:flex;gap:10px">
                        <input type="number" min="0" id="rmWeight" class="mini-input" style="width:50%" placeholder="Kilo">
                        <input type="number" min="0" id="rmReps" class="mini-input" style="width:50%" placeholder="Tekrar">
                    </div>
                    <button onclick="calc1RM()" class="spin-btn" style="width:100%;margin-top:15px">1RM Hesapla</button>
                    <div id="rmResult" style="font-size:2rem;text-align:center;margin-top:20px;color:var(--blue)"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal full-modal" id="statsModal">
        <div class="sheet" style="padding-top:60px;">
            <div class="close-sticky" onclick="closeModal('statsModal')">‚úï</div>
            <h2>ƒ∞statistikler</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="number" min="0" id="userHeight" class="mini-input" style="width:50%; padding:15px" placeholder="Boy (cm)" onchange="saveStats()">
                <input type="number" min="0" id="dailyWeight" class="mini-input" style="width:50%; padding:15px" placeholder="Kilo (kg)" oninput="saveData()">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="number" min="0" max="24" id="sleepHours" class="mini-input" style="width:50%; padding:15px" placeholder="Uyku (saat)" oninput="saveData()">
                <select id="sleepQuality" class="mini-input" style="width:50%; padding:15px; text-align:left;" onchange="saveData()">
                    <option value="">Uyku Kalitesi</option>
                    <option value="1">1 - K√∂t√º</option>
                    <option value="2">2 - Orta K√∂t√º</option>
                    <option value="3">3 - Orta</option>
                    <option value="4">4 - ƒ∞yi</option>
                    <option value="5">5 - M√ºkemmel</option>
                </select>
            </div>
            <div class="alert-box alert-imbalance" id="legAlert">
                <span>üêî</span>
                <div><b>Chicken Leg Uyarƒ±sƒ±!</b><br>√úst v√ºcut hacmi bacaklara g√∂re √ßok artmƒ±≈ü. Haftaya en az 2 bacak g√ºn√º ekle.</div>
            </div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px; text-align:center">Kas Yoƒüunluk Haritasƒ±</h4>
            <div class="anatomy-container">
                <svg class="anatomy-svg" viewBox="0 0 100 200">
                    <circle cx="50" cy="20" r="10" fill="#333" />
                    <path id="svg-shoulders" class="muscle-path" d="M30 35 L70 35 L75 45 L25 45 Z" />
                    <path id="svg-arms" class="muscle-path" d="M25 45 L15 80 L22 80 L30 45 Z M75 45 L85 80 L78 80 L70 45 Z" />
                    <path id="svg-chest" class="muscle-path" d="M35 45 L65 45 L60 65 L40 65 Z" />
                    <path id="svg-core" class="muscle-path" d="M40 65 L60 65 L58 90 L42 90 Z" />
                    <path id="svg-legs" class="muscle-path" d="M38 90 L62 90 L65 140 L55 140 L52 100 L48 100 L45 140 L35 140 Z" />
                </svg>
            </div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">Aƒürƒ± Haritasƒ±</h4>
            <div class="pain-grid" id="painMapGrid">
                <div class="pain-part" onclick="togglePain('diz')">Diz</div>
                <div class="pain-part" onclick="togglePain('bel')">Bel</div>
                <div class="pain-part" onclick="togglePain('omuz')">Omuz</div>
                <div class="pain-part" onclick="togglePain('bilek')">Bilek</div>
                <div class="pain-part" onclick="togglePain('kalca')">Kal√ßa</div>
            </div>
            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">Son Ma√ßlar</h4>
            <div id="gameHistory"></div>

            <h4 style="margin-top:20px; border-top:1px solid #333; padding-top:10px">Haftalƒ±k √ñzet</h4>
            <div id="weeklySummary" style="font-size:0.85rem; color:#ccc;"></div>
        </div>
    </div>

    <div class="modal" id="plateModal">
        <div class="sheet">
            <h2>Plaka Hesaplayƒ±cƒ±</h2>
            <input type="number" min="0" id="plateTarget" class="mini-input" style="width:100%; font-size:1.5rem; padding:15px; margin-bottom:10px;" placeholder="Hedef (kg)" oninput="calcPlates()">
            <div id="plateResult" style="color:var(--accent);font-weight:bold;margin-bottom:10px"></div>
            <div id="plateVisual" class="plate-visual"></div>
            <span onclick="closeModal('plateModal')" style="position:absolute;top:20px;right:20px;font-size:1.5rem; cursor:pointer;">‚úï</span>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="sheet">
            <h2 id="histTitle">Ge√ßmi≈ü</h2>
            <div id="histList" style="margin-top:15px;"></div>
            <span onclick="closeModal('historyModal')" style="position:absolute;top:20px;right:20px;font-size:1.5rem; cursor:pointer;">‚úï</span>
        </div>
    </div>

    <div class="modal" id="builderModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between;">
                <h2>Program Yap</h2>
                <span onclick="closeModal('builderModal')" style="cursor:pointer;">‚úï</span>
            </div>
            <select id="mainMuscle" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px" onchange="updateSec()">
                <option value="">1. B√∂lge</option>
                <option value="chest">G√∂ƒü√ºs</option>
                <option value="back">Sƒ±rt</option>
                <option value="legs">Bacak</option>
                <option value="shoulders">Omuz</option>
                <option value="arms">Kol</option>
            </select>
            <select id="subMuscle" style="width:100%;padding:12px;background:#000;color:#fff;border:1px solid #333;border-radius:8px;margin-bottom:10px" disabled>
                <option>2. B√∂lge</option>
            </select>
            <div class="toggle-row">
                <span>üèÄ Sƒ±√ßrama Ekle (Booster)</span>
                <label class="switch">
                    <input type="checkbox" id="addJump">
                    <span class="slider"></span>
                </label>
            </div>
            <button onclick="buildProg()" style="width:100%;padding:15px;background:var(--blue);border:none;border-radius:8px;color:#fff;font-weight:bold">Uygula</button>
        </div>
    </div>

    <div class="modal" id="readinessModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between;">
                <h2>G√ºnl√ºk Hazƒ±rlƒ±k</h2>
                <span onclick="closeModal('readinessModal')" style="cursor:pointer;">‚úï</span>
            </div>
            <p style="color:#aaa; margin-bottom:20px">Bug√ºn kendini nasƒ±l hissediyorsun?</p>
            <div class="readiness-scale" style="display:flex; justify-content:space-between; font-size:2rem;">
                <div class="r-btn" onclick="setReadiness(1)">üò´</div>
                <div class="r-btn" onclick="setReadiness(2)">ü•±</div>
                <div class="r-btn" onclick="setReadiness(3)">üòê</div>
                <div class="r-btn" onclick="setReadiness(4)">üôÇ</div>
                <div class="r-btn" onclick="setReadiness(5)">üî•</div>
            </div>
        </div>
    </div>

    <div class="modal" id="gameLogModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between;">
                <h2>üèÄ Ma√ß Karnesi</h2>
                <span onclick="closeModal('gameLogModal')" style="cursor:pointer;">‚úï</span>
            </div>
            <div style="display:flex; gap:10px; margin:20px 0;">
                <input type="number" min="0" id="gamePoints" class="mini-input" style="width:50%; padding:15px" placeholder="Sayƒ±">
                <input type="number" min="0" id="gameAssists" class="mini-input" style="width:50%; padding:15px" placeholder="Asist">
            </div>
            <div style="display:flex; gap:10px; margin:10px 0;">
                <input type="number" min="0" id="gameRebounds" class="mini-input" style="width:50%; padding:15px" placeholder="Rib">
                <input type="number" min="0" id="gameSteals" class="mini-input" style="width:50%; padding:15px" placeholder="T√á">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="gameResult" style="width:100%; padding:12px; background:#222; color:#fff; border:1px solid #333; border-radius:8px;">
                    <option value="">Ma√ß Sonucu</option>
                    <option value="W">Galibiyet (W)</option>
                    <option value="L">Maƒülubiyet (L)</option>
                </select>
            </div>
            <textarea id="gameNotes" style="width:100%; background:#000; border:1px solid #333; color:#fff; padding:10px; border-radius:8px" placeholder="Ma√ß yorumu..."></textarea>
            <button onclick="saveGameLog()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:10px; margin-top:15px; font-weight:bold">Kaydet</button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Ayarlar</h2>
                <span onclick="closeModal('settingsModal')" style="cursor:pointer;">‚úï</span>
            </div>

            <div class="toggle-row">
                <span>üèÄ Sezon ƒ∞√ßi</span>
                <label class="switch">
                    <input type="checkbox" id="seasonToggle" onchange="toggleSeason()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <span>üîä Ses Efektleri</span>
                <label class="switch">
                    <input type="checkbox" id="soundToggle" onchange="toggleSound()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <span>üéØ Hedef</span>
                <select id="goalSelect" style="flex:1; padding:8px; background:#000; color:#fff; border:1px solid #333; border-radius:8px;" onchange="changeGoal(this.value)">
                    <option value="balanced">Dengeli Geli≈üim</option>
                    <option value="strength">Kuvvet</option>
                    <option value="jump">Zƒ±plama / Patlayƒ±cƒ±lƒ±k</option>
                    <option value="fatloss">Yaƒü Yakƒ±mƒ±</option>
                    <option value="game">Ma√ß Performansƒ±</option>
                </select>
            </div>

            <div style="display:flex; gap:10px; margin:20px 0">
                <button onclick="exportData()" class="backup-btn" style="width:100%; padding:10px; background:#222; color:var(--blue); border:1px solid var(--blue); border-radius:8px;">üì• ƒ∞ndir</button>
                <button onclick="document.getElementById('importFile').click()" class="backup-btn" style="width:100%; padding:10px; background:#222; color:var(--warn); border:1px solid var(--warn); border-radius:8px;">üì§ Y√ºkle</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <button onclick="resetApp()" style="width:100%; padding:15px; background:var(--danger); border:none; border-radius:10px; color:#fff; font-weight:bold">Sƒ±fƒ±rla</button>
        </div>
    </div>

    <div class="modal" id="challengeModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between;">
                <h2>Meydan Okuma</h2>
                <span onclick="closeModal('challengeModal')" style="cursor:pointer;">‚úï</span>
            </div>
            <div style="background:#111; padding:20px; border-radius:12px; text-align:center; margin-top:20px">
                <h3 style="margin:0; color:var(--warn)" id="challengeTitle">1000 ≈ûƒ±nav</h3>
                <div style="font-size:2rem; font-weight:bold; margin:10px 0" id="challengeDisplay">0 / 1000</div>
                <div class="progress-track"><div class="progress-fill" id="challengeBarFill" style="width:0%; background:var(--warn)"></div></div>
                <div style="margin-top:20px; display:flex; gap:10px; justify-content:center">
                    <button class="mini-input" onclick="addChallenge(10)">+10</button>
                    <button class="mini-input" onclick="addChallenge(25)">+25</button>
                    <button class="mini-input" onclick="addChallenge(50)">+50</button>
                </div>
                <button onclick="setChallenge()" style="margin-top:15px; background:none; border:none; color:#555; font-size:0.8rem; text-decoration:underline">Hedefi Deƒüi≈ütir</button>
            </div>
        </div>
    </div>

    <script>
        // --- VISUALS ---
        const visuals = {
            push: `<svg viewBox="0 0 24 24"><path d="M4 18h16v-2H4v2zM8 6h8v2H8V6zm4 4c-1.1 0-2 .9-2 2v4h4v-4c0-1.1-.9-2-2-2z" fill="#fff"/></svg>`,
            pull: `<svg viewBox="0 0 24 24"><path d="M12 2C9.24 2 7 4.24 7 7v4h2V7h10v4h2V7c0-2.76-2.24-5-5-5h-4zm-2 12v8h4v-8h-4z" fill="#fff"/></svg>`,
            legs: `<svg viewBox="0 0 24 24"><path d="M12 4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-2 16v-4h4v4h-4zm0-6h4v-2h-4v2zm-4 6h2v-6H6v6zm12 0h2v-6h-2v6z" fill="#fff"/></svg>`,
            press: `<svg viewBox="0 0 24 24"><path d="M12 2L4 10h5v12h6V10h5L12 2z" fill="#fff"/></svg>`,
            core: `<svg viewBox="0 0 24 24"><path d="M20 18h-2v-2h-2v2H8v-2H6v2H4v-6c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v6z" fill="#fff"/></svg>`,
            arm: `<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-2v5H6v2h2v5h2v-5h2v-2z" fill="#fff"/></svg>`,
            cardio: `<svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8.4L13 19v4h2v-5l-1.8-3.6 1.8-1.4c.6-.5 1.1-.7 1.7-.7.3 0 .5.1.8.2L20 13v-2l-2.1-.6c-1.1-.4-2.4-.1-3.2.7l-1.5 1.5-1.4-4.1z" fill="#fff"/></svg>`,
            pilates: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="none" stroke="#fff" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#fff"/></svg>`
        };

        const quotes = [
            "Yetenek seni zirveye ta≈üƒ±r, karakter orada tutar.",
            "Antrenman bittiƒüinde asƒ±l geli≈üim ba≈ülar.",
            "Bug√ºn yaptƒ±ƒüƒ±n her tekrar yarƒ±nki zaferin tuƒülasƒ±dƒ±r.",
            "Yorgunluk sadece zihnindedir."
        ];

        // --- MUSCLE DB (ANA + ALTERNATƒ∞F) ---
        const muscleDB = {
            chest: {
                t: "G√∂ƒü√ºs",
                mb: "chest",
                i: [
                    { n: "Bench Press (4x8)", v: "push", d: "Barƒ± g√∂ƒü√ºs hizasƒ±na kontroll√º indir, topuklardan g√º√ß al.", alt: ["Dumbbell Bench Press", "Push-Up (≈ûƒ±nav)"] },
                    { n: "Incline Press (3x10)", v: "push", d: "Hafif eƒüimli sehpada √ºst g√∂ƒüse odaklan.", alt: ["Incline Dumbbell Press", "Feet-Elevated Push-Up"] }
                ]
            },
            back: {
                t: "Sƒ±rt",
                mb: "back",
                i: [
                    { n: "Pull Up / Lat Pull (4x8)", v: "pull", d: "√áeneni bara getir, k√ºrek kemiklerini sƒ±kƒ±≈ütƒ±r.", alt: ["Lat Pulldown", "Band Assisted Pull-Up"] },
                    { n: "Barbell / Cable Row (3x10)", v: "pull", d: "√áubuƒüu g√∂bek hizasƒ±na √ßek, belini sabit tut.", alt: ["One Arm Dumbbell Row", "Chest Supported Row"] }
                ]
            },
            legs: {
                t: "Bacak",
                mb: "legs",
                i: [
                    { n: "Back Squat (4x6-8)", v: "legs", d: "Topuklara bas, g√∂ƒüs√ºn dik, paralelin altƒ±na inmeyi hedefle.", alt: ["Front Squat", "Goblet Squat", "Leg Press"] },
                    { n: "RDL / Romanian Deadlift (3x8)", v: "legs", d: "Kal√ßayƒ± geriye it, barƒ± v√ºcuda yakƒ±n tut.", alt: ["Hip Thrust", "Good Morning (hafif)", "Glute Bridge"] }
                ]
            },
            shoulders: {
                t: "Omuz",
                mb: "shoulders",
                i: [
                    { n: "Overhead Press (3x8)", v: "press", d: "Karnƒ± sƒ±k, barƒ± √ßeneden yukarƒ± d√ºz hatta it.", alt: ["Dumbbell Shoulder Press", "Arnold Press"] },
                    { n: "Lateral Raise (3x12)", v: "press", d: "Dirsek hafif kƒ±rƒ±k, omuzu hissederek yana a√ß.", alt: ["Cable Lateral Raise", "Lean-Away Lateral Raise"] }
                ]
            },
            arms: {
                t: "Kol",
                mb: "arms",
                i: [
                    { n: "Biceps Curl (3x10)", v: "arm", d: "V√ºcudu sallamadan, kontroll√º kaldƒ±r indir.", alt: ["Incline Dumbbell Curl", "Hammer Curl"] },
                    { n: "Triceps Pushdown (3x12)", v: "arm", d: "Dirsekler sabit, sadece √∂n kol hareket etsin.", alt: ["Overhead Triceps Extension", "Dips (Bench Dips)"] }
                ]
            },
            core: {
                t: "Karƒ±n",
                mb: "core",
                i: [
                    { n: "Plank (3x30sn)", v: "core", d: "Kal√ßayƒ± d√º≈ü√ºrme, kaburgayƒ± a≈üaƒüƒ± √ßek.", alt: ["Side Plank", "Dead Bug"] }
                ]
            }
        };

        const compat = {
            chest: ['arms', 'shoulders'],
            back: ['arms', 'shoulders'],
            legs: ['core'],
            shoulders: ['arms'],
            arms: ['core']
        };

        const jumpR = [
            { n: "Pogo Hops (3x20)", v: "legs", d: "Bilekleri kilitle, hƒ±zlƒ± ve hafif sƒ±√ßra.", alt: ["Line Hops", "Jump Rope (Hafif)"] },
            { n: "Box Jump (3x8)", v: "legs", d: "Al√ßak bir kutuya patlayƒ±cƒ± ≈üekilde zƒ±pla.", alt: ["Tuck Jump", "Broad Jump"] },
            { n: "Depth Jump (3x5)", v: "legs", d: "Kutu √ºzerinden in, yere deƒüer deƒümez patlayƒ±cƒ± zƒ±pla.", alt: ["Drop Squat + Jump", "Low Box Step-Off Jump"] }
        ];

        // FINISHERS (Cƒ∞LA) + DETAY
        const finishers = {
            gym: [
                { label: "üî• 1 Dakika Plank", desc: "Dirsek √ºzerinde, core sƒ±kƒ±, kal√ßa d√ºz; nefese odaklan.", query: "1 minute plank proper form" },
                { label: "üî• 50 Mekik", desc: "Boynunu √ßekme, g√∂vdeyi kaburgadan katla.", query: "crunch exercise tutorial" },
                { label: "üî• Tabata Burpee (4dk)", desc: "20 sn full burpee / 10 sn dinlen, 8 tur.", query: "tabata burpee workout" },
                { label: "üî• 100 ≈ûƒ±nav (Toplam)", desc: "Setlere b√∂l, form bozulmadan tamamla.", query: "push up volume challenge" },
                { label: "üî• Farmer's Walk", desc: "Aƒüƒ±r dambƒ±llarla dik y√ºr√º, omuz ve core √ßalƒ±≈üsƒ±n.", query: "farmer walk exercise" },
                { label: "üî• Dead Hang (Max S√ºre)", desc: "Barfix barƒ±na asƒ±l, kavrama ve omuzlarƒ± g√º√ßlendir.", query: "dead hang benefits" }
            ],
            basket: [
                { label: "üèÄ 5 Noktadan 10'ar ≈ûut", desc: "K√∂≈üeler, kanatlar ve tepe; toplam 50 ≈üut.", query: "basketball spot shooting drill" },
                { label: "üèÄ 50 Serbest Atƒ±≈ü (Sokmadan √áƒ±kma)", desc: "Rutinini oturt, ka√ßanlarƒ± not et.", query: "free throw routine tips" },
                { label: "üèÄ Mikan Drill (2 Dakika)", desc: "Potanƒ±n iki yanƒ±ndan bitiri≈ü √ßalƒ±≈ümasƒ±.", query: "mikan drill tutorial" },
                { label: "üèÄ 3 Sayƒ± Yarƒ±≈ümasƒ± (10'da Ka√ß?)", desc: "10 √º√ßl√ºk, skorunu kaydet.", query: "basketball 3 point shooting drill" },
                { label: "üèÄ Sahayƒ± 5 Kere Tam Tur Ko≈ü", desc: "Tam saha sprint + y√ºr√ºyerek d√∂n√º≈ü; kondisyon.", query: "basketball suicide conditioning drill" }
            ]
        };

        const clutchTasks = [
            "1 Dakika Plank yapmadan eve gidemezsin!",
            "√úst √ºste 10 serbest atƒ±≈ü sok!",
            "50 ≈ûƒ±nav √ßek, hemen!"
        ];

        // FOOD DB GENƒ∞≈ûLETƒ∞LMƒ∞≈û
        const foodDB = [
            // Kahvaltƒ± / Brunch
            { n: "Yumurta (1 Adet)", c: 70, p: 6, t: "kahvalti" },
            { n: "Yulaf (50g)", c: 190, p: 6, t: "kahvalti" },
            { n: "Yulaf + Yoƒüurt + Muz", c: 320, p: 14, t: "kahvalti" },
            { n: "Menemen (2 Yumurta)", c: 220, p: 14, t: "kahvalti" },
            { n: "Peynirli Tam Tahƒ±llƒ± Tost", c: 280, p: 15, t: "kahvalti" },

            // Ana √ñƒü√ºnler
            { n: "Tavuk G√∂ƒüs√º (150g)", c: 165, p: 31, t: "ogun" },
            { n: "Izgara K√∂fte (150g)", c: 350, p: 25, t: "ogun" },
            { n: "Hindi G√∂ƒü√ºs (150g)", c: 180, p: 32, t: "ogun" },
            { n: "Somon Izgara (150g)", c: 280, p: 30, t: "ogun" },
            { n: "Pilav (1 Kase)", c: 200, p: 4, t: "karbonhidrat" },
            { n: "Makarna (1 Tabak)", c: 250, p: 8, t: "karbonhidrat" },
            { n: "Patates Ha≈ülama (Orta)", c: 160, p: 4, t: "karbonhidrat" },
            { n: "Mercimek (1 Tabak)", c: 230, p: 18, t: "ogun" },

            // Ara √ñƒü√ºnler
            { n: "Muz (Orta)", c: 105, p: 1, t: "ara" },
            { n: "Elma", c: 52, p: 0, t: "ara" },
            { n: "Badem/Ceviz (1 Avu√ß)", c: 160, p: 6, t: "ara" },
            { n: "Yoƒüurt (1 Kase)", c: 100, p: 10, t: "ara" },
            { n: "Lor Peyniri (100g)", c: 90, p: 15, t: "ara" },
            { n: "Protein Bar", c: 200, p: 20, t: "ara" },
            { n: "Pirin√ß Patlaƒüƒ± (1 ad)", c: 30, p: 1, t: "ara" },
            { n: "Fƒ±stƒ±k Ezmesi (1 tk)", c: 90, p: 3, t: "ara" },
            { n: "Protein Shake", c: 120, p: 24, t: "ara" },
            { n: "Ton Balƒ±ƒüƒ± (100g)", c: 130, p: 25, t: "ara" },
            { n: "Hindi F√ºme (2 Dilim)", c: 60, p: 10, t: "ara" }
        ];

        // WARMUP DB GENƒ∞≈ûLETƒ∞LMƒ∞≈û
        const warmupDB = {
            "Y√ºr√ºy√º≈ü": { d: "Kan akƒ±≈üƒ±nƒ± ba≈ülat, zihni antrenmana hazƒ±rla. 5-10 dk hafif tempo." },
            "Rotator Cuff": { d: "Lastikle dƒ±≈üa/i√ße rotasyon. Omuz saƒülƒ±ƒüƒ± i√ßin temel sigorta." },
            "Tibialis": { d: "Duvara yaslanƒ±p parmak ucu kaldƒ±rma. √ñn bacak kasƒ±nƒ± g√º√ßlendir, diz aƒürƒ±sƒ±nƒ± √∂nle." },
            "Patellar Tendon": { d: "Spanish Squat veya duvara dayalƒ± izometrik bekleme. Diz kapaƒüƒ± altƒ±nƒ± g√º√ßlendirir." },
            "Kal√ßa Flexor": { d: "Lunge pozisyonunda arka bacaƒüƒ± sƒ±kƒ±p esnet. Uzun oturma sonrasƒ± birebir." },
            "Omuz Mob.": { d: "Sopa veya bant ile omuz √ßevirme (Dislocates). T√ºm overhead press‚Äôler i√ßin." },
            "Kal√ßa Akt.": { d: "Monster Walk, side step veya glute bridge ile kal√ßayƒ± uyandƒ±r." },
            "Dinamik Isƒ±nma": { d: "High Knees, Butt Kicks, kol savurma. Nabzƒ± kademeli y√ºkselt." },
            "Jacks": { d: "Jumping Jacks ile nabzƒ± 120+ civarƒ±na getir, v√ºcudu uyandƒ±r." }
        };

        // Aƒürƒ± ‚Üí ekstra prehab e≈üle≈ümeleri
        const painPrehabMap = {
            diz: ["Patellar Tendon", "Tibialis"],
            bel: ["Kal√ßa Akt.", "Dinamik Isƒ±nma"],
            omuz: ["Rotator Cuff", "Omuz Mob."],
            kalca: ["Kal√ßa Akt.", "Kal√ßa Flexor"]
        };

        // SEZON PROGRAMLARI
        const seasonSchedule = {
            0: { t: "Dinlenme", s: "Recovery", j: false, pre: ["Y√ºr√ºy√º≈ü"], i: [{ n: "Meal Prep", v: "rest", d: "Haftanƒ±n √∂ƒü√ºnlerini planla." }] },
            1: { t: "Chest & Triceps", s: "ƒ∞tme", j: false, pre: ["Rotator Cuff"], i: [...muscleDB.chest.i, { n: "Triceps Pushdown (Ek)", v: "arm", d: "Triceps‚Äôe son dokunu≈ü.", alt: ["Dips", "Overhead Rope Extension"] }] },
            2: { t: "Pilates & Basket", s: "Yoƒüun", j: false, pre: ["Tibialis"], i: [{ n: "Pilates (19:00)", v: "pilates", d: "Core, nefes ve mobilite.", alt: ["Mat Pilates Seansƒ±"] }, { n: "Basketbol (20:45)", v: "cardio", d: "≈ûut ve oyun okuma.", alt: ["Bireysel ≈ûut √áalƒ±≈ümasƒ±"] }] },
            3: { t: "Ma√ß G√ºn√º", s: "Game Night", j: true, pre: ["Patellar Tendon"], i: [{ n: "Ma√ß (21:45)", v: "cardio", isGame: true, d: "Ritim, savunma ve doƒüru kararlar.", alt: ["Full Court Scrimmage"] }] },
            4: { t: "Pilates", s: "Recovery", j: false, pre: ["Kal√ßa Flexor"], i: [{ n: "Pilates (19:00)", v: "pilates", d: "Esneklik, denge ve core.", alt: ["Yoga Flow"] }] },
            5: { t: "Back & Biceps", s: "√áekme", j: true, pre: ["Omuz Mob."], i: [...muscleDB.back.i, { n: "Ek Curl (Pump)", v: "arm", d: "Negatif kontrol ile biceps pompasƒ±.", alt: ["Cable Curl", "Preacher Curl"] }] },
            6: { t: "Legs & Shoulders", s: "Kuvvet", j: false, pre: ["Kal√ßa Akt."], i: [...muscleDB.legs.i, ...muscleDB.shoulders.i] },
            panic: { t: "Ev Modu", s: "Home", j: false, pre: ["Jacks"], i: [{ n: "50 ≈ûƒ±nav", v: "push", d: "Nizami formda b√∂lerek tamamla.", alt: ["ƒ∞ncline ≈ûƒ±nav", "Diz √úst√º ≈ûƒ±nav"] }, { n: "50 Squat", v: "legs", d: "V√ºcut aƒüƒ±rlƒ±ƒüƒ± ile derin squatlar.", alt: ["Lunge", "Step-Up"] }] }
        };

        const offSeasonSchedule = JSON.parse(JSON.stringify(seasonSchedule));
        offSeasonSchedule[3] = {
            t: "CANAVAR MODU",
            s: "Off-Season",
            j: true,
            pre: ["Dinamik Isƒ±nma"],
            i: [
                { n: "Deadlift (Aƒüƒ±r)", v: "legs", d: "Omurgayƒ± kilitle, barƒ± bacaklara yakƒ±n tut.", alt: ["Trap Bar Deadlift", "RDL (Orta Aƒüƒ±rlƒ±k)"] },
                { n: "Heavy Rows", v: "pull", d: "Sƒ±rt kalƒ±nlƒ±ƒüƒ± i√ßin kontroll√º aƒüƒ±r setler.", alt: ["T-Bar Row", "Chest Supported Row"] },
                { n: "HIIT", v: "cardio", d: "Kƒ±sa s√ºreli sert intervallerle nabzƒ± patlat.", alt: ["Bike Sprint", "Rowing Sprint"] }
            ]
        };

        // GLOBAL STATE
        let today = new Date();
        let data, stats, settings;
        let timerInt = null, timerSec = 0;

        const getK = d => d.toLocaleDateString('fr-CA'); // YYYY-MM-DD

        function init() {
            try {
                data = JSON.parse(localStorage.getItem('primeDataV21')) || {};
                stats = JSON.parse(localStorage.getItem('primeStatsV21')) || {
                    xp: 0,
                    height: 0,
                    challenge: { target: 1000, current: 0, title: "1000 ≈ûƒ±nav" },
                    streak: 0,
                    lastLogin: "",
                    max: {},
                    games: [],
                    heat: {},
                    history: {},
                    pain: []
                };
                settings = JSON.parse(localStorage.getItem('primeSettingsV21')) || { sound: false, inSeason: true, goal: "balanced" };

                const k = getK(today);
                if (!data[k]) data[k] = { c: [], s: {}, w: {}, rpe: {}, n: "", wt: 0, nutri: { cal: 0, pro: 0, log: [], supps: [], timing: [] }, panic: false, readiness: 0 };

                if (!stats.heat) stats.heat = { chest: 0, back: 0, legs: 0, shoulders: 0, arms: 0, core: 0 };

                document.getElementById('dailyQuote').innerHTML = `"${quotes[today.getDate() % quotes.length]}"`;

                if (data[k].readiness === 0) openModal('readinessModal');

                document.getElementById('seasonToggle').checked = settings.inSeason;
                document.getElementById('soundToggle').checked = settings.sound;
                document.getElementById('userHeight').value = stats.height || "";
                const goalSelect = document.getElementById('goalSelect');
                if (goalSelect) goalSelect.value = settings.goal || "balanced";

                updateChallengeUI();
                renderFoodList();
                render();
                renderXP();
                renderHeatmap();
                renderGameHistory();
                renderPainMap();
                renderWeeklySummary();
            } catch (e) {
                alert("Veri hatasƒ± algƒ±landƒ±. Uygulama sƒ±fƒ±rlanƒ±yor...");
                console.error(e);
                localStorage.clear();
                location.reload();
            }
        }

        function save() {
            localStorage.setItem('primeDataV21', JSON.stringify(data));
        }
        function saveStats() {
            stats.height = document.getElementById('userHeight').value;
            localStorage.setItem('primeStatsV21', JSON.stringify(stats));
        }

        function render() {
            const k = getK(today);
            if (!data[k]) data[k] = { c: [], s: {}, w: {}, rpe: {}, n: "", wt: 0, nutri: { cal: 0, pro: 0, log: [], supps: [], timing: [] }, panic: false, readiness: 0 };
            const dd = data[k];

            document.getElementById('dateDisplay').innerText = today.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric' });

            const baseSchedule = settings.inSeason ? seasonSchedule[today.getDay()] : offSeasonSchedule[today.getDay()];
            const p = dd.panic ? seasonSchedule.panic : (dd.custom || baseSchedule);

            document.getElementById('progTitle').innerText = p.t;
            document.getElementById('progSub').innerText = p.s;
            document.getElementById('seasonBadge').innerText = settings.inSeason ? "SEZON ƒ∞√áƒ∞" : "OFF-SEASON";

            const readinessMap = ["Enerji: ?", "Enerji: √áok D√º≈ü√ºk", "Enerji: D√º≈ü√ºk", "Enerji: Orta", "Enerji: ƒ∞yi", "Enerji: üî•"];
            document.getElementById('readinessBadge').innerText = readinessMap[dd.readiness || 0];

            const focusMap = {
                balanced: "ODAK: Dengeli Geli≈üim",
                strength: "ODAK: Kuvvet",
                jump: "ODAK: Zƒ±plama & Patlayƒ±cƒ±lƒ±k",
                fatloss: "ODAK: Yaƒü Yakƒ±mƒ±",
                game: "ODAK: Ma√ß Performansƒ±"
            };
            document.getElementById('focusBadge').innerText = focusMap[settings.goal] || "";

            // PREHAB + Aƒürƒ± bazlƒ± ekler
            const phList = document.getElementById('prehabList');
            phList.innerHTML = "";
            let prehabNames = new Set(p.pre || []);
            if (stats.pain && Array.isArray(stats.pain)) {
                stats.pain.forEach(code => {
                    (painPrehabMap[code] || []).forEach(name => prehabNames.add(name));
                });
            }
            prehabNames.forEach(item => {
                const meta = warmupDB[item] || { d: "Hazƒ±rlƒ±k." };
                phList.innerHTML += `
                    <div class="prehab-item">
                        <div>
                            <div style="font-weight:600">${item}</div>
                            <span class="prehab-desc">${meta.d}</span>
                        </div>
                        <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(item + " exercise")}" target="_blank" class="yt-btn">‚ñ∂</a>
                    </div>`;
            });

            const list = document.getElementById('workoutList');
            list.innerHTML = '';
            let vol = 0;
            p.i.forEach((it, i) => {
                const chk = dd.c.includes(i);
                const kg = parseInt(dd.w[i] || 0);
                const sets = parseInt(dd.s[i] || 3);
                if (chk && kg > 0) vol += kg * sets;

                const fullName = it.n;
                const name = it.n.split('(')[0].trim();
                const isPR = kg > (stats.max[name] || 0) && kg > 0;
                const rpeVal = dd.rpe && dd.rpe[i] ? dd.rpe[i] : "";

                const hasLoad = it.v !== 'rest' && it.v !== 'pilates' && it.v !== 'cardio';

                list.innerHTML += `
                    <div class="task-item ${chk ? 'checked' : ''}" id="task-${i}">
                        <div class="task-top">
                            <div class="task-visual" onclick="toggleGuide(${i})">${visuals[it.v] || visuals.push}</div>
                            <div class="check-group" onclick="toggle(${i},'${it.isGame ? 'game' : ''}',${p.i.length})">
                                <div style="flex:1"><span class="task-name">${fullName}</span></div>
                                <div class="circle-check"></div>
                            </div>
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(name + " nasƒ±l yapƒ±lƒ±r")}" target="_blank" class="yt-btn">‚ñ∂</a>
                        </div>
                        <div class="guide-text">üí° ${it.d || "Kontroll√º."}</div>
                        ${it.alt ? `<div class="alt-text">Alternatifler: ${it.alt.map(a => `<a href="https://www.youtube.com/results?search_query=${encodeURIComponent(a + ' exercise')}" target="_blank">${a}</a>`).join(', ')}</div>` : ''}
                        ${hasLoad ? `
                        <div class="input-row">
                            <input class="mini-input" type="number" min="0" placeholder="Set" value="${dd.s[i] || ''}" onchange="saveS(${i},this.value)">
                            <input class="mini-input ${isPR ? 'pr-active' : ''}" type="number" min="0" placeholder="Kg" value="${dd.w[i] || ''}" onchange="saveW('${name.replace(/'/g, "\\'")}',${i},this.value,${sets})">
                            <button class="tool-btn" onclick="openCalc(${kg || 0})">üßÆ</button>
                            <button class="tool-btn" onclick="openHist('${name.replace(/'/g, "\\'")}')">üìú</button>
                        </div>
                        <div class="rpe-container ${rpeVal ? 'active' : ''}">
                            <span>RPE</span>
                            <input class="rpe-slider" type="range" min="5" max="10" value="${rpeVal || 7}" oninput="saveRPE(${i}, this.value)">
                            <span id="rpeLabel-${i}">${rpeVal ? rpeVal : ''}</span>
                        </div>` : ''}
                    </div>`;
            });

            document.getElementById('totalVolume').innerText = vol + " kg";
            const progPercent = p.i.length ? Math.round((dd.c.length / p.i.length) * 100) : 0;
            document.getElementById('progPercent').innerText = "%" + (isNaN(progPercent) ? 0 : progPercent);

            updateTrackers(dd);
            updateAlerts();
            renderWeeklySummary();
        }

        // CHECKBOX + XP FARM FIX
        function toggle(i, s, t) {
            const k = getK(today);
            const day = data[k];
            const a = day.c;
            if (a.includes(i)) {
                a.splice(a.indexOf(i), 1);
                addXP(-10); // XP geri al
            } else {
                a.push(i);
                startTimer();
                addXP(10);
                updateHeatmap(i);
                if (s === 'game') openModal('gameLogModal');
                if (a.length === t) checkClutch();
            }
            save();
            render();
        }

        function checkClutch() {
            if (Math.random() < 0.3) {
                document.getElementById('clutchTaskDisplay').innerText = clutchTasks[Math.floor(Math.random() * clutchTasks.length)];
                openModal('clutchModal');
            } else {
                showWrapUp();
            }
        }

        function completeClutch() {
            addXP(100);
            closeModal('clutchModal');
            showWrapUp();
        }

        function showWrapUp() {
            const k = getK(today);
            const dt = data[k];
            let vol = 0;
            if (dt && dt.w) {
                Object.keys(dt.w).forEach(idx => {
                    const w = parseInt(dt.w[idx] || 0);
                    const s = parseInt(dt.s && dt.s[idx] ? dt.s[idx] : 3);
                    if (w > 0) vol += w * s;
                });
            }
            document.getElementById('wrapVol').innerText = vol;
            document.getElementById('wrapXP').innerText = "+" + (dt.c.length * 10);
            openModal('wrapUpModal');
            fireConfetti();
        }

        function addJumpToToday() {
            const k = getK(today);
            const idx = today.getDay();
            const base = settings.inSeason ? seasonSchedule[idx] : offSeasonSchedule[idx];
            let cur = data[k].custom ? data[k].custom : base;

            if (cur.i.find(x => x.n === jumpR[0].n)) {
                alert("Zaten zƒ±plama setleri eklenmi≈ü!");
                return;
            }

            data[k].custom = {
                t: cur.t + " + Jump",
                s: cur.s,
                j: true,
                pre: cur.pre,
                i: [...cur.i, ...jumpR]
            };
            save();
            render();
            alert("Zƒ±plama setleri eklendi!");
        }

        function saveW(n, i, v, s) {
            const k = getK(today);
            const w = parseFloat(v) || 0;
            data[k].w[i] = w;
            if (w > (stats.max[n] || 0)) {
                stats.max[n] = w;
                alert("REKOR! üèÜ");
            }
            stats.history[n] = { w: w, s: s, d: k };
            save();
            saveStats();
            render();
        }

        function saveS(i, v) {
            const k = getK(today);
            data[k].s[i] = parseInt(v) || 0;
            save();
        }

        function saveRPE(i, val) {
            const k = getK(today);
            if (!data[k].rpe) data[k].rpe = {};
            data[k].rpe[i] = parseInt(val) || "";
            const label = document.getElementById('rpeLabel-' + i);
            if (label) label.innerText = val;
            const row = document.getElementById('task-' + i);
            if (row) {
                const rpeRow = row.querySelector('.rpe-container');
                if (rpeRow) rpeRow.classList.add('active');
            }
            save();
        }

        function addXP(x) {
            stats.xp = (stats.xp || 0) + x;
            if (stats.xp < 0) stats.xp = 0;
            saveStats();
            renderXP();
        }

        function renderXP() {
            const xp = stats.xp || 0;
            document.getElementById('xpBar').style.width = (xp % 1000) / 10 + "%";
            document.getElementById('xpText').innerText = xp + " XP";
            document.getElementById('currentLvl').innerText = "Lvl " + Math.floor(xp / 1000 + 1);

            const rankEl = document.getElementById('userRank');
            const rankMap = {
                balanced: "All-Rounder",
                strength: "Strength Focus",
                jump: "Vertical Beast",
                fatloss: "Lean Mode",
                game: "Game Night"
            };
            if (rankEl) rankEl.innerText = rankMap[settings.goal] || "Rookie";
        }

        function updateTrackers(dd) {
            document.getElementById('waterCount').innerText = (dd.wt || 0) + " lt";
            document.getElementById('journal').value = dd.n || "";
            document.getElementById('dailyWeight').value = dd.bw || "";
            document.getElementById('sleepHours').value = dd.sleepH || "";
            document.getElementById('sleepQuality').value = dd.sleepQ || "";

            const cal = dd.nutri?.cal || 0;
            const pro = dd.nutri?.pro || 0;
            const tCal = 2500;
            const tPro = 160;

            document.getElementById('calStatus').innerText = cal + " kcal";
            document.getElementById('proStatus').innerText = pro + "g";
            document.getElementById('targetCalDisplay').innerText = tCal;
            document.getElementById('calText').innerText = `${cal} / ${tCal}`;
            document.getElementById('proText').innerText = `${pro} / ${tPro}g`;
            document.getElementById('calBar').style.width = Math.min((cal / tCal) * 100, 100) + "%";
            document.getElementById('proBar').style.width = Math.min((pro / tPro) * 100, 100) + "%";

            updateMacroHint(cal, pro, tCal, tPro);

            const l = document.getElementById('foodLog');
            l.innerHTML = "";
            if (dd.nutri?.log) dd.nutri.log.forEach(f => l.innerHTML += `<div>‚Ä¢ ${f.n} (${f.c}kcal, ${f.p}g)</div>`);

            const todaySched = settings.inSeason ? seasonSchedule[today.getDay()] : offSeasonSchedule[today.getDay()];
            if (todaySched && todaySched.j) document.getElementById('nutrientTimingBox').style.display = 'block';
            else document.getElementById('nutrientTimingBox').style.display = 'none';

            document.querySelectorAll('.supp-icon').forEach(el => el.classList.remove('active'));
            if (dd.nutri?.supps) dd.nutri.supps.forEach(s => document.getElementById('supp-' + s)?.classList.add('active'));

            document.querySelectorAll('.timing-item').forEach(el => el.classList.remove('timing-active'));
            if (dd.nutri?.timing) dd.nutri.timing.forEach(t => document.getElementById('time-' + t)?.classList.add('timing-active'));
        }

        function updateMacroHint(cal, pro, tCal, tPro) {
            const el = document.getElementById('macroHint');
            if (!el) return;
            const calDiff = tCal - cal;
            const proDiff = tPro - pro;
            let txt = "";

            if (calDiff > 150 || proDiff > 15) {
                txt += `Bug√ºn yakla≈üƒ±k ${Math.max(calDiff, 0)} kcal ve ${Math.max(proDiff, 0)}g protein eksik g√∂r√ºn√ºyor. `;
                if (proDiff > 20) {
                    txt += "√ñneri: 200g yoƒüurt + 100g lor + 1-2 pirin√ß patlaƒüƒ±.";
                } else {
                    txt += "√ñneri: 1 protein shake + 1 muz.";
                }
            } else if (calDiff < -150) {
                txt += `Hedefin yakla≈üƒ±k ${Math.abs(calDiff)} kcal √ºzerine √ßƒ±ktƒ±n. Yarƒ±n biraz daha hafif yiyebilirsin.`;
            } else if (proDiff < -20) {
                txt += `Protein hedefini ${Math.abs(proDiff)}g kadar a≈ütƒ±n, sorun deƒüil ama sƒ±vƒ± alƒ±mƒ±nƒ± artƒ±r.`;
            } else {
                txt = "Makrolar hedefe olduk√ßa yakƒ±n, ufak bir ara √∂ƒü√ºnle g√ºn√º rahat kapatabilirsin.";
            }
            el.innerText = txt;
        }

        function renderFoodList() {
            const g = document.getElementById('foodGrid');
            g.innerHTML = "";
            foodDB.forEach((f, i) => {
                g.innerHTML += `<div class="food-item" onclick="addFood(${i})"><b>${f.n}</b><small>${f.c}kcal / ${f.p}g</small></div>`;
            });
        }

        function addFood(i) {
            const f = foodDB[i];
            const k = getK(today);
            if (!data[k].nutri) data[k].nutri = { cal: 0, pro: 0, log: [], supps: [], timing: [] };
            data[k].nutri.cal += f.c;
            data[k].nutri.pro += f.p;
            if (!data[k].nutri.log) data[k].nutri.log = [];
            data[k].nutri.log.push(f);
            save();
            render();
        }

        function addQuickMacros() {
            const c = parseInt(document.getElementById('quickCal').value) || 0;
            const p = parseInt(document.getElementById('quickPro').value) || 0;
            if (c > 0 || p > 0) {
                const k = getK(today);
                if (!data[k].nutri) data[k].nutri = { cal: 0, pro: 0, log: [], supps: [], timing: [] };
                data[k].nutri.cal += c;
                data[k].nutri.pro += p;
                if (!data[k].nutri.log) data[k].nutri.log = [];
                data[k].nutri.log.push({ n: "Hƒ±zlƒ± Ekleme", c: c, p: p });
                document.getElementById('quickCal').value = "";
                document.getElementById('quickPro').value = "";
                save();
                render();
            }
        }

        function clearNutrition() {
            if (confirm("Beslenme kaydƒ± silinsin mi?")) {
                const k = getK(today);
                const supps = data[k].nutri?.supps || [];
                const timing = data[k].nutri?.timing || [];
                data[k].nutri = { cal: 0, pro: 0, log: [], supps, timing };
                save();
                render();
            }
        }

        function renderHeatmap() {
            const c = { low: '#333', med: '#ffd60a', high: '#ff453a' };
            const setFill = (id, val) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (val > 20) el.style.fill = c.high;
                else if (val > 5) el.style.fill = c.med;
                else el.style.fill = c.low;
            };
            setFill('svg-chest', stats.heat.chest || 0);
            setFill('svg-shoulders', stats.heat.shoulders || 0);
            setFill('svg-arms', stats.heat.arms || 0);
            setFill('svg-legs', stats.heat.legs || 0);
            setFill('svg-core', stats.heat.core || 0);

            // Chicken leg uyarƒ±sƒ±
            const legAlert = document.getElementById('legAlert');
            if (legAlert) {
                const upper = (stats.heat.chest || 0) + (stats.heat.shoulders || 0) + (stats.heat.arms || 0);
                const legs = stats.heat.legs || 0;
                if (upper >= legs * 2 && upper > 10) legAlert.style.display = 'flex';
                else legAlert.style.display = 'none';
            }
        }

        function updateHeatmap(i) {
            const k = getK(today);
            const dd = data[k];
            const baseSched = settings.inSeason ? seasonSchedule[today.getDay()] : offSeasonSchedule[today.getDay()];
            const p = dd.custom || baseSched;
            const ex = p.i[i];
            const mb = ex.mb || (muscleDB[p.mb] ? p.mb : "core");
            stats.heat[mb] = (stats.heat[mb] || 0) + 1;
            saveStats();
            renderHeatmap();
        }

        function renderGameHistory() {
            const d = document.getElementById('gameHistory');
            d.innerHTML = "";
            (stats.games || []).slice(-5).reverse().forEach(g => {
                const pts = g.pts ?? g.points ?? 0;
                const ast = g.ast ?? g.assists ?? 0;
                const reb = g.reb ?? 0;
                const stl = g.stl ?? 0;
                const res = g.res || "";
                const badge = res === "W" ? " | W" : (res === "L" ? " | L" : "");
                d.innerHTML += `<div style="background:#111; padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #333; font-size:0.8rem;">
                    ${g.date}${badge} - ${pts} Sayƒ± / ${ast} Asist${reb ? " / " + reb + " Rib" : ""}${stl ? " / " + stl + " T√á" : ""}
                </div>`;
            });
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function switchToolTab(t) {
            document.querySelectorAll('.tool-content').forEach(e => e.style.display = 'none');
            document.getElementById('tool-' + t).style.display = 'block';
            document.querySelectorAll('.n-tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function toggleGuide(i) {
            document.getElementById(`task-${i}`).classList.toggle('show-guide');
        }

        function startTimer() {
            const el = document.getElementById('timerFloat');
            el.classList.add('active');
            if (timerInt) clearInterval(timerInt);
            timerSec = 90;
            updT();
            timerInt = setInterval(() => {
                timerSec--;
                updT();
                if (timerSec <= 0) {
                    stopTimer();
                    notify();
                }
            }, 1000);
        }

        function addTimer(sec) {
            timerSec += sec;
            if (timerSec < 0) timerSec = 0;
            updT();
        }

        function stopTimer() {
            clearInterval(timerInt);
            document.getElementById('timerFloat').classList.remove('active');
        }
        function updT() {
            const m = Math.floor(timerSec / 60), s = timerSec % 60;
            document.getElementById('timerDisplay').innerText = `0${m}:${s < 10 ? '0' + s : s}`;
        }

        function notify() {
            if (settings.sound && 'speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance("S√ºre doldu!");
                u.lang = 'tr-TR';
                window.speechSynthesis.speak(u);
            } else if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function addWater() {
            const k = getK(today);
            data[k].wt = (data[k].wt || 0) + 0.5;
            save();
            render();
        }

        function setReadiness(v) {
            const k = getK(today);
            data[k].readiness = v;
            save();
            closeModal('readinessModal');
            render();
        }

        function togglePanic() {
            const k = getK(today);
            data[k].panic = !data[k].panic;
            save();
            render();
        }

        function changeDate(d) {
            today.setDate(today.getDate() + d);
            init();
        }

        function toggleSupp(s) {
            const k = getK(today);
            if (!data[k].nutri) data[k].nutri = { cal: 0, pro: 0, log: [], supps: [], timing: [] };
            if (!data[k].nutri.supps) data[k].nutri.supps = [];
            if (data[k].nutri.supps.includes(s)) data[k].nutri.supps = data[k].nutri.supps.filter(x => x !== s);
            else data[k].nutri.supps.push(s);
            save();
            render();
        }

        function toggleTiming(t) {
            const k = getK(today);
            if (!data[k].nutri) data[k].nutri = { cal: 0, pro: 0, log: [], supps: [], timing: [] };
            if (!data[k].nutri.timing) data[k].nutri.timing = [];
            if (data[k].nutri.timing.includes(t)) data[k].nutri.timing = data[k].nutri.timing.filter(x => x !== t);
            else data[k].nutri.timing.push(t);
            save();
            render();
        }

        function calc1RM() {
            const w = parseFloat(document.getElementById('rmWeight').value);
            const r = parseFloat(document.getElementById('rmReps').value);
            if (w && r) document.getElementById('rmResult').innerText = Math.round(w * (1 + r / 30)) + " kg";
        }

        function openCalc(kg) {
            document.getElementById('plateTarget').value = kg || "";
            calcPlates();
            openModal('plateModal');
        }

        function calcPlates() {
            const t = parseFloat(document.getElementById('plateTarget').value);
            const vis = document.getElementById('plateVisual');
            const res = document.getElementById('plateResult');
            vis.innerHTML = '';
            if (!t || t <= 20) {
                res.innerText = "";
                return;
            }
            let w = (t - 20) / 2;
            res.innerText = "Her tarafa " + w.toFixed(1) + " kg plaka";

            [25, 20, 15, 10, 5, 2.5, 1.25].forEach(p => {
                while (w >= p - 0.01) {
                    w -= p;
                    vis.innerHTML += `<div class="plate" style="width:${28 + p}px; background:${p>=25?'#ff3b30':(p>=20?'#0a84ff':(p>=10?'#32d74b':'#ffd60a'))}">${p}</div>`;
                }
            });
        }

        function openHist(n) {
            const h = stats.history[n];
            const max = stats.max[n] || 0;
            document.getElementById('histTitle').innerText = n + " Ge√ßmi≈üi";
            document.getElementById('histList').innerHTML =
                (max > 0 ? `<div style="color:var(--gold); font-weight:bold; margin-bottom:10px;">üèÜ PR: ${max} kg</div>` : "") +
                (h ? `<div>Son: ${h.w}kg x ${h.s} (${h.d})</div>` : "Hen√ºz veri yok.");
            openModal('historyModal');
        }

        // Men√º Sihirbazƒ±
        function generateMenu() {
            const scenarioList = ["ofis", "ev", "mac"];
            const scenario = scenarioList[Math.floor(Math.random() * scenarioList.length)];

            const pick = (tag) => {
                const list = foodDB.filter(f => f.t === tag);
                return list[Math.floor(Math.random() * list.length)];
            };

            let title = "";
            let kah, o, aksam, ara;

            if (scenario === "ofis") {
                title = "Ofis G√ºn√º Men√ºs√º";
                kah = pick("kahvalti");
                o = pick("ogun");
                aksam = pick("ogun");
                ara = pick("ara");
            } else if (scenario === "ev") {
                title = "Evde √áalƒ±≈üma Men√ºs√º";
                kah = pick("kahvalti");
                o = pick("ogun");
                aksam = pick("ogun");
                ara = pick("ara");
            } else {
                title = "Ma√ß G√ºn√º Men√ºs√º";
                kah = pick("kahvalti");
                o = pick("ogun");
                aksam = pick("ogun");
                ara = pick("ara");
            }

            const sum = (...items) => {
                return {
                    c: items.reduce((a, x) => a + (x?.c || 0), 0),
                    p: items.reduce((a, x) => a + (x?.p || 0), 0)
                };
            };

            const totals = sum(kah, o, aksam, ara);

            document.getElementById('menuResult').innerHTML = `
                <div style="background:#222; padding:15px; margin-top:15px; border-radius:12px; border:1px solid #333;">
                    <b>${title}</b><br><br>
                    <b>Kahvaltƒ±:</b> ${kah.n}<br>
                    <b>√ñƒüle:</b> ${o.n}<br>
                    <b>Ak≈üam:</b> ${aksam.n}<br>
                    <b>Ara √ñƒü√ºn:</b> ${ara.n}<br><br>
                    <span style="font-size:0.8rem; color:#ccc;">Yakla≈üƒ±k: ${totals.c} kcal / ${totals.p}g protein</span>
                </div>`;
        }

        function togglePain(p) {
            if (!stats.pain) stats.pain = [];
            if (stats.pain.includes(p)) stats.pain = stats.pain.filter(x => x !== p);
            else stats.pain.push(p);
            saveStats();
            renderPainMap();
            render();
        }

        function renderPainMap() {
            document.querySelectorAll('.pain-part').forEach(el => el.classList.remove('active'));
            if (stats.pain) stats.pain.forEach(p => {
                const el = document.querySelector(`.pain-part[onclick="togglePain('${p}')"]`);
                if (el) el.classList.add('active');
            });
        }

        function toggleSeason() {
            settings.inSeason = document.getElementById('seasonToggle').checked;
            localStorage.setItem('primeSettingsV21', JSON.stringify(settings));
            render();
        }
        function toggleSound() {
            settings.sound = document.getElementById('soundToggle').checked;
            localStorage.setItem('primeSettingsV21', JSON.stringify(settings));
        }

        function changeGoal(val) {
            settings.goal = val || "balanced";
            localStorage.setItem('primeSettingsV21', JSON.stringify(settings));
            renderXP();
            render();
        }

        function resetApp() {
            if (confirm("T√ºm veriler silinsin mi?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function startBreathing() {
            const el = document.getElementById('breathCircle');
            let phase = 0;
            const cycle = () => {
                if (phase === 0) { el.innerText = "AL"; el.style.transform = "scale(1.5)"; }
                else if (phase === 1) { el.innerText = "TUT"; }
                else if (phase === 2) { el.innerText = "VER"; el.style.transform = "scale(1)"; }
                else if (phase === 3) { el.innerText = "TUT"; }
                phase = (phase + 1) % 4;
            };
            cycle();
            setInterval(cycle, 4000);
        }

        function closeZone() {
            closeModal('zoneModal');
        }

        function saveGameLog() {
            const p = document.getElementById('gamePoints').value;
            const a = document.getElementById('gameAssists').value;
            const r = document.getElementById('gameRebounds').value;
            const s = document.getElementById('gameSteals').value;
            const res = document.getElementById('gameResult').value || "";
            const note = document.getElementById('gameNotes').value || "";

            if (p || a || r || s) {
                stats.games.push({
                    date: getK(today),
                    pts: parseInt(p) || 0,
                    ast: parseInt(a) || 0,
                    reb: parseInt(r) || 0,
                    stl: parseInt(s) || 0,
                    res,
                    note
                });
                saveStats();
                closeModal('gameLogModal');
                renderGameHistory();
                renderWeeklySummary();
            }
        }

        function fireConfetti() {
            const c = document.getElementById('confetti');
            const x = c.getContext('2d');
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            let p = [];
            for (let i = 0; i < 60; i++) p.push({ x: Math.random() * c.width, y: -10, v: Math.random() * 5 + 2, c: 'hsl(' + Math.random() * 360 + ',100%,50%)' });
            function l() {
                x.clearRect(0, 0, c.width, c.height);
                let a = false;
                p.forEach(o => {
                    o.y += o.v;
                    if (o.y < c.height) {
                        a = true;
                        x.fillStyle = o.c;
                        x.fillRect(o.x, o.y, 5, 5);
                    }
                });
                if (a) requestAnimationFrame(l);
            }
            l();
        }

        function exportData() {
            const d = { data: data, stats: stats, settings: settings };
            const b = new Blob([JSON.stringify(d)], { type: 'application/json' });
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = 'prime_backup.json'; a.click();
        }

        function importData(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = (e) => {
                const d = JSON.parse(e.target.result);
                localStorage.setItem('primeDataV21', JSON.stringify(d.data));
                localStorage.setItem('primeStatsV21', JSON.stringify(d.stats));
                localStorage.setItem('primeSettingsV21', JSON.stringify(d.settings));
                location.reload();
            };
            r.readAsText(f);
        }

        function saveData() {
            const k = getK(today);
            if (!data[k]) return;
            const j = document.getElementById('journal');
            const bw = document.getElementById('dailyWeight');
            const sh = document.getElementById('sleepHours');
            const sq = document.getElementById('sleepQuality');
            if (j) data[k].n = j.value;
            if (bw) data[k].bw = bw.value;
            if (sh) data[k].sleepH = sh.value;
            if (sq) data[k].sleepQ = sq.value;
            save();
        }

        // Finisher (Cila)
        function spinFinisher() {
            const type = document.querySelector('input[name="fType"]:checked').value || "gym";
            const pool = finishers[type] || finishers.gym;
            const choice = pool[Math.floor(Math.random() * pool.length)];
            const box = document.getElementById('finisherResult');
            box.style.display = 'block';
            box.innerHTML = `${choice.label}<br><small style="color:#ccc;">${choice.desc}</small><br>
                <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(choice.query)}" target="_blank" class="yt-btn" style="margin-top:8px; display:inline-flex; justify-content:center;">‚ñ∂ YouTube</a>`;
        }

        // Haftalƒ±k metrikler + load
        function computeWeeklyMetrics() {
            const res = { volume: 0, trainDays: 0, jumpDays: 0 };
            const base = new Date(today);
            for (let offset = 0; offset < 7; offset++) {
                const d = new Date(base);
                d.setDate(base.getDate() - offset);
                const key = getK(d);
                const dd = data[key];
                if (!dd) continue;

                let dayVol = 0;
                if (dd.w) {
                    Object.keys(dd.w).forEach(idx => {
                        const w = parseFloat(dd.w[idx] || 0);
                        const s = parseFloat(dd.s && dd.s[idx] ? dd.s[idx] : 3);
                        if (w > 0) dayVol += w * s;
                    });
                }
                if (dayVol > 0) res.volume += dayVol;
                if (dd.c && dd.c.length > 0) res.trainDays++;

                let sched = dd.custom;
                const weekday = d.getDay();
                if (!sched) sched = (settings.inSeason ? seasonSchedule[weekday] : offSeasonSchedule[weekday]);
                if (sched && sched.j) res.jumpDays++;
            }
            return res;
        }

        function updateAlerts() {
            const lowEl = document.getElementById('lowEnergyAlert');
            const highEl = document.getElementById('highEnergyAlert');
            const deloadEl = document.getElementById('deloadAlert');
            const k = getK(today);
            const dd = data[k];

            lowEl.style.display = 'none';
            highEl.style.display = 'none';
            deloadEl.style.display = 'none';

            if (!dd) return;

            const metrics = computeWeeklyMetrics();
            if (metrics.trainDays >= 5 && metrics.volume > 15000) {
                deloadEl.style.display = 'flex';
            }

            const sleepH = parseFloat(dd.sleepH || 0);
            const readiness = dd.readiness || 0;

            if ((sleepH && sleepH <= 5) || readiness <= 2) {
                lowEl.style.display = 'flex';
            } else if ((sleepH && sleepH >= 7) && readiness >= 4) {
                highEl.style.display = 'flex';
            }
        }

        function renderWeeklySummary() {
            const box = document.getElementById('weeklySummary');
            if (!box) return;
            const metrics = computeWeeklyMetrics();

            const earliest = new Date(today);
            earliest.setDate(today.getDate() - 6);
            const earliestKey = getK(earliest);

            const weekGames = (stats.games || []).filter(g => g.date >= earliestKey);
            let totalPts = 0, totalAst = 0;
            weekGames.forEach(g => {
                totalPts += g.pts || 0;
                totalAst += g.ast || 0;
            });

            const avgPts = weekGames.length ? (totalPts / weekGames.length).toFixed(1) : 0;
            const avgAst = weekGames.length ? (totalAst / weekGames.length).toFixed(1) : 0;

            let comment = "";
            if (metrics.trainDays >= 5 && metrics.jumpDays <= 1) {
                comment = "Bu hafta aƒüƒ±rlƒ±k iyi ama zƒ±plama az kalmƒ±≈ü. √ñn√ºm√ºzdeki hafta en az 2 g√ºn sƒ±√ßrama ekleyebilirsin.";
            } else if (metrics.trainDays <= 3) {
                comment = "Antrenman sayƒ±sƒ± d√º≈ü√ºk. Haftada 4 g√ºne √ßƒ±kmak ritmini artƒ±racaktƒ±r.";
            } else if (weekGames.length > 0 && avgPts >= 15) {
                comment = "Ma√ß skorlarƒ±n gayet iyi. ≈ûimdi karar alma ve savunma detaylarƒ±na odaklanma zamanƒ±.";
            } else {
                comment = "Y√ºk fena deƒüil. Formu korumak i√ßin uyku ve beslenmeyi bozmadan aynƒ± ritmi s√ºrd√ºr.";
            }

            box.innerHTML = `
                <div>Son 7 g√ºn: <b>${metrics.trainDays}</b> antrenman, <b>${metrics.jumpDays}</b> zƒ±plama odaklƒ± g√ºn.</div>
                <div>Toplam hacim: <b>${Math.round(metrics.volume)} kg</b></div>
                <div>Ma√ß sayƒ±sƒ±: <b>${weekGames.length}</b> | Ort. Sayƒ±: <b>${avgPts}</b> | Ort. Asist: <b>${avgAst}</b></div>
                <div style="margin-top:6px; color:#aaa;">Ko√ß yorumu: ${comment}</div>
            `;
        }

        // Challenge UI
        function updateChallengeUI() {
            const c = stats.challenge || { target: 1000, current: 0, title: "1000 ≈ûƒ±nav" };
            const pct = Math.min((c.current / c.target) * 100, 100);
            const short = document.getElementById('challengeShort');
            const bar = document.getElementById('challengeBarFill');
            const disp = document.getElementById('challengeDisplay');
            const title = document.getElementById('challengeTitle');
            if (short) short.innerText = `${c.current}/${c.target}`;
            if (bar) bar.style.width = pct + "%";
            if (disp) disp.innerText = `${c.current} / ${c.target}`;
            if (title) title.innerText = c.title || "Meydan Okuma";
        }

        function addChallenge(delta) {
            if (!stats.challenge) stats.challenge = { target: 1000, current: 0, title: "1000 ≈ûƒ±nav" };
            stats.challenge.current += delta;
            if (stats.challenge.current < 0) stats.challenge.current = 0;
            if (stats.challenge.current > stats.challenge.target) stats.challenge.current = stats.challenge.target;
            saveStats();
            updateChallengeUI();
        }

        function setChallenge() {
            const yeni = prompt("Yeni hedef (√∂r: 500 ≈ûƒ±nav):", stats.challenge?.title || "1000 ≈ûƒ±nav");
            if (!yeni) return;
            const sayi = parseInt(yeni) || 1000;
            stats.challenge = { title: yeni, target: sayi, current: 0 };
            saveStats();
            updateChallengeUI();
        }

        function updateSec() {
            const main = document.getElementById('mainMuscle').value;
            const sub = document.getElementById('subMuscle');
            sub.innerHTML = "<option>2. B√∂lge</option>";
            sub.disabled = false;
            (compat[main] || []).forEach(m => {
                sub.innerHTML += `<option value="${m}">${muscleDB[m].t}</option>`;
            });
        }

        function buildProg() {
            const main = document.getElementById('mainMuscle').value;
            const subVal = document.getElementById('subMuscle').value;
            const addJump = document.getElementById('addJump').checked;
            const k = getK(today);
            if (!main) { alert("√ñnce 1. b√∂lgeyi se√ß."); return; }
            let i = [...(muscleDB[main]?.i || [])];
            if (subVal && muscleDB[subVal]) i = [...i, ...muscleDB[subVal].i];
            if (addJump) i = [...i, ...jumpR];

            data[k].custom = {
                t: muscleDB[main].t + (subVal ? " + " + muscleDB[subVal].t : ""),
                s: "Custom",
                j: !!addJump,
                pre: ["Dinamik Isƒ±nma"],
                i
            };
            save();
            closeModal('builderModal');
            render();
        }

        window.onload = init;
    </script>
</body>
</html>
